

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scribe.models &mdash; SCRIBE  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SCRIBE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickoverview.html">Quick Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Available Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../models/index.html">Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../results.html">Results Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SCRIBE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">scribe.models</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for scribe.models</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Models for single-cell RNA sequencing data.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Import JAX-related libraries</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="c1"># Import Pyro-related libraries</span>
<span class="kn">import</span> <span class="nn">numpyro</span>
<span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">numpyro.distributions</span> <span class="kn">import</span> <span class="n">constraints</span>

<span class="c1"># Import typing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Import model config</span>
<span class="kn">from</span> <span class="nn">.model_config</span> <span class="kn">import</span> <span class="n">ModelConfig</span>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Negative Binomial-Dirichlet Multinomial Model</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="nbdm_model">
<a class="viewcode-back" href="../../api/models.html#scribe.models.nbdm_model">[docs]</a>
<span class="k">def</span> <span class="nf">nbdm_model</span><span class="p">(</span>
    <span class="n">n_cells</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_genes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">total_counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Numpyro model for Negative Binomial-Dirichlet Multinomial single-cell RNA</span>
<span class="sd">    sequencing data.</span>
<span class="sd">    </span>
<span class="sd">    This model assumes that for each cell:</span>
<span class="sd">        1. The total UMI count follows a Negative Binomial distribution with</span>
<span class="sd">           parameters r_total and p</span>
<span class="sd">        2. Given the total count, the individual gene counts follow a</span>
<span class="sd">           Dirichlet-Multinomial distribution with concentration parameters r</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_cells : int</span>
<span class="sd">        Number of cells in the dataset</span>
<span class="sd">    n_genes : int</span>
<span class="sd">        Number of genes in the dataset</span>
<span class="sd">    model_config : ModelConfig</span>
<span class="sd">        Configuration object containing prior distributions for model</span>
<span class="sd">        parameters: - p_distribution_model: Prior for success probability p -</span>
<span class="sd">        r_distribution_model: Prior for dispersion parameters r</span>
<span class="sd">    counts : array-like, optional</span>
<span class="sd">        Observed counts matrix of shape (n_cells, n_genes). If None, generates</span>
<span class="sd">        samples from the prior.</span>
<span class="sd">    total_counts : array-like, optional</span>
<span class="sd">        Total UMI counts per cell of shape (n_cells,). Required if counts is</span>
<span class="sd">        provided.</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        Mini-batch size for stochastic variational inference. If None, uses full</span>
<span class="sd">        dataset.</span>

<span class="sd">    Model Structure</span>
<span class="sd">    --------------</span>
<span class="sd">    Global Parameters:</span>
<span class="sd">        - Success probability p ~ model_config.p_distribution_model</span>
<span class="sd">        - Gene-specific dispersion r ~ model_config.r_distribution_model</span>

<span class="sd">    Likelihood:</span>
<span class="sd">        - total_counts ~ NegativeBinomialProbs(r_total, p)</span>
<span class="sd">        - counts ~ DirichletMultinomial(r, total_count=total_counts)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sample p</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_model</span><span class="p">)</span>
    
    <span class="c1"># Sample r</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_model</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">n_genes</span><span class="p">]))</span>

    <span class="c1"># Sum of r parameters</span>
    <span class="n">r_total</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;r_total&quot;</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

    <span class="c1"># If we have observed data, condition on it</span>
    <span class="k">if</span> <span class="n">counts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If batch size is not provided, use the entire dataset</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Define plate for cells total counts</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
                <span class="c1"># Likelihood for the total counts - one for each cell</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;total_counts&quot;</span><span class="p">,</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r_total</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span>
                    <span class="n">obs</span><span class="o">=</span><span class="n">total_counts</span>
                <span class="p">)</span>

            <span class="c1"># Define plate for cells individual counts</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
                <span class="c1"># Likelihood for the individual counts - one for each cell</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;counts&quot;</span><span class="p">,</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">DirichletMultinomial</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">total_count</span><span class="o">=</span><span class="n">total_counts</span><span class="p">),</span>
                    <span class="n">obs</span><span class="o">=</span><span class="n">counts</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Define plate for cells total counts</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span>
                <span class="s2">&quot;cells&quot;</span><span class="p">,</span>
                <span class="n">n_cells</span><span class="p">,</span>
                <span class="n">subsample_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">idx</span><span class="p">:</span>
                <span class="c1"># Likelihood for the total counts - one for each cell</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;total_counts&quot;</span><span class="p">,</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r_total</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span>
                    <span class="n">obs</span><span class="o">=</span><span class="n">total_counts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="c1"># Define plate for cells individual counts</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span>
                <span class="s2">&quot;cells&quot;</span><span class="p">,</span>
                <span class="n">n_cells</span><span class="p">,</span>
                <span class="n">subsample_size</span><span class="o">=</span><span class="n">batch_size</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">idx</span><span class="p">:</span>
                <span class="c1"># Likelihood for the individual counts - one for each cell</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;counts&quot;</span><span class="p">,</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">DirichletMultinomial</span><span class="p">(</span>
                        <span class="n">r</span><span class="p">,</span> <span class="n">total_count</span><span class="o">=</span><span class="n">total_counts</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span>
                    <span class="n">obs</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Predictive model (no obs)</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
            <span class="c1"># Make a NegativeBinomial distribution that returns a vector of</span>
            <span class="c1"># length n_genes</span>
            <span class="n">dist_nb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">dist_nb</span><span class="p">)</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Beta-Gamma Variational Posterior for Negative Binomial-Dirichlet Multinomial</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="nbdm_guide">
<a class="viewcode-back" href="../../api/models.html#scribe.models.nbdm_guide">[docs]</a>
<span class="k">def</span> <span class="nf">nbdm_guide</span><span class="p">(</span>
    <span class="n">n_cells</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_genes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">total_counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define the variational distribution for stochastic variational inference.</span>
<span class="sd">    </span>
<span class="sd">    This guide defines the variational distributions for the NBDM model</span>
<span class="sd">    parameters using the configuration specified in model_config.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_cells : int</span>
<span class="sd">        Number of cells in the dataset</span>
<span class="sd">    n_genes : int</span>
<span class="sd">        Number of genes in the dataset</span>
<span class="sd">    model_config : ModelConfig</span>
<span class="sd">        Configuration object containing the variational distribution</span>
<span class="sd">        specifications:</span>
<span class="sd">            - p_distribution_guide: Distribution for success probability p</span>
<span class="sd">            - r_distribution_guide: Distribution for dispersion parameters r</span>
<span class="sd">    counts : array_like, optional</span>
<span class="sd">        Observed counts matrix of shape (n_cells, n_genes)</span>
<span class="sd">    total_counts : array_like, optional</span>
<span class="sd">        Total counts per cell of shape (n_cells,)</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        Mini-batch size for stochastic optimization</span>

<span class="sd">    Guide Structure</span>
<span class="sd">    --------------</span>
<span class="sd">    Variational Parameters:</span>
<span class="sd">        - Success probability p ~ model_config.p_distribution_guide</span>
<span class="sd">        - Gene-specific dispersion r ~ model_config.r_distribution_guide</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract p distribution values</span>
    <span class="n">p_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract p distribution parameters and constraints</span>
    <span class="n">p_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">p_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">p_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">p_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;p_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">p_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>

    <span class="c1"># Extract r distribution values</span>
    <span class="n">r_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract r distribution parameters and constraints </span>
    <span class="n">r_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">r_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">r_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">r_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;r_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_genes</span><span class="p">)</span> <span class="o">*</span> <span class="n">r_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>

    <span class="c1"># Sample p from variational distribution using unpacked parameters</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">p_params</span><span class="p">))</span>
    <span class="c1"># Sample r from variational distribution using unpacked parameters</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">r_params</span><span class="p">))</span></div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Zero-Inflated Negative Binomial Model</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="zinb_model">
<a class="viewcode-back" href="../../api/models.html#scribe.models.zinb_model">[docs]</a>
<span class="k">def</span> <span class="nf">zinb_model</span><span class="p">(</span>
    <span class="n">n_cells</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_genes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Numpyro model for Zero-Inflated Negative Binomial single-cell RNA sequencing</span>
<span class="sd">    data.</span>
<span class="sd">    </span>
<span class="sd">    This model uses the configuration defined in model_config. It implements a</span>
<span class="sd">    Zero-Inflated Negative Binomial distribution with shared success probability</span>
<span class="sd">    p across all genes, but gene-specific dispersion and dropout parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_cells : int</span>
<span class="sd">        Number of cells in the dataset</span>
<span class="sd">    n_genes : int</span>
<span class="sd">        Number of genes in the dataset</span>
<span class="sd">    model_config : ModelConfig</span>
<span class="sd">        Configuration object for model distributions containing:</span>
<span class="sd">            - p_distribution_model: Distribution for success probability p</span>
<span class="sd">            - r_distribution_model: Distribution for dispersion parameters r</span>
<span class="sd">            - gate_distribution_model: Distribution for dropout probabilities</span>
<span class="sd">    counts : array-like, optional</span>
<span class="sd">        Observed counts matrix of shape (n_cells, n_genes). If None, generates</span>
<span class="sd">        samples from the prior.</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        Mini-batch size for stochastic variational inference. If None, uses full</span>
<span class="sd">        dataset.</span>

<span class="sd">    Model Structure</span>
<span class="sd">    --------------</span>
<span class="sd">    Global Parameters:</span>
<span class="sd">        - Success probability p ~ model_config.p_distribution_model</span>
<span class="sd">        - Gene-specific dispersion r ~ model_config.r_distribution_model</span>
<span class="sd">        - Gene-specific dropout probabilities gate ~</span>
<span class="sd">          model_config.gate_distribution_model</span>

<span class="sd">    Likelihood:</span>
<span class="sd">        - counts ~ ZeroInflatedNegativeBinomial(r, p, gate)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sample p</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_model</span><span class="p">)</span>
    
    <span class="c1"># Sample r</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_model</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">n_genes</span><span class="p">]))</span>
    
    <span class="c1"># Sample gate (dropout) parameters for all genes simultaneously</span>
    <span class="n">gate</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;gate&quot;</span><span class="p">,</span> 
        <span class="n">model_config</span><span class="o">.</span><span class="n">gate_distribution_model</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">n_genes</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># Create base negative binomial distribution</span>
    <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    
    <span class="c1"># Create zero-inflated distribution</span>
    <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span><span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># If we have observed data, condition on it</span>
    <span class="k">if</span> <span class="n">counts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If batch size is not provided, use the entire dataset</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Define plate for cells</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
                <span class="c1"># Likelihood for the counts - one for each cell</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">zinb</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">counts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Define plate for cells</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span>
                <span class="s2">&quot;cells&quot;</span><span class="p">,</span>
                <span class="n">n_cells</span><span class="p">,</span>
                <span class="n">subsample_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">idx</span><span class="p">:</span>
                <span class="c1"># Likelihood for the counts - one for each cell</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">zinb</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Predictive model (no obs)</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
            <span class="c1"># Make the distribution return a vector of length n_genes</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">zinb</span><span class="p">)</span></div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Beta-Gamma-Beta Variational Posterior for Zero-Inflated Negative Binomial</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="zinb_guide">
<a class="viewcode-back" href="../../api/models.html#scribe.models.zinb_guide">[docs]</a>
<span class="k">def</span> <span class="nf">zinb_guide</span><span class="p">(</span>
    <span class="n">n_cells</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_genes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define the variational distribution for stochastic variational inference of</span>
<span class="sd">    the Zero-Inflated Negative Binomial model.</span>
<span class="sd">    </span>
<span class="sd">    This guide function specifies the form of the variational distribution that</span>
<span class="sd">    will be optimized to approximate the true posterior. It defines a mean-field</span>
<span class="sd">    variational family where each parameter has its own independent distribution</span>
<span class="sd">    specified by the model_config object.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_cells : int</span>
<span class="sd">        Number of cells in the dataset</span>
<span class="sd">    n_genes : int</span>
<span class="sd">        Number of genes in the dataset</span>
<span class="sd">    model_config : ModelConfig</span>
<span class="sd">        Configuration object containing guide distributions for model parameters:</span>
<span class="sd">        - p_distribution_guide: Guide distribution for success probability p</span>
<span class="sd">        - r_distribution_guide: Guide distribution for dispersion parameters r</span>
<span class="sd">        - gate_distribution_guide: Guide distribution for dropout probabilities</span>
<span class="sd">    counts : array-like, optional</span>
<span class="sd">        Observed counts matrix of shape (n_cells, n_genes). Not directly used in</span>
<span class="sd">        the guide but included for API consistency with the model</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        Mini-batch size for stochastic variational inference. Not used in this</span>
<span class="sd">        guide since all parameters are global.</span>

<span class="sd">    Guide Structure</span>
<span class="sd">    --------------</span>
<span class="sd">    Variational Parameters:</span>
<span class="sd">        - Success probability p ~ model_config.p_distribution_guide</span>
<span class="sd">        - Gene-specific dispersion r ~ model_config.r_distribution_guide</span>
<span class="sd">        - Gene-specific dropout probabilities gate ~</span>
<span class="sd">          model_config.gate_distribution_guide</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract p distribution values</span>
    <span class="n">p_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract p distribution parameters and constraints</span>
    <span class="n">p_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">p_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">p_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">p_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;p_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">p_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>

    <span class="c1"># Extract r distribution values</span>
    <span class="n">r_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract r distribution parameters and constraints </span>
    <span class="n">r_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">r_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">r_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">r_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;r_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_genes</span><span class="p">)</span> <span class="o">*</span> <span class="n">r_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>

    <span class="c1"># Extract gate distribution values</span>
    <span class="n">gate_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">gate_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract gate distribution parameters and constraints</span>
    <span class="n">gate_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">gate_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">gate_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">gate_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">gate_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;gate_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_genes</span><span class="p">)</span> <span class="o">*</span> <span class="n">gate_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>
    
    <span class="c1"># Sample p from variational distribution using unpacked parameters</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">p_params</span><span class="p">))</span>
    <span class="c1"># Sample r from variational distribution using unpacked parameters</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">r_params</span><span class="p">))</span>
    <span class="c1"># Sample gate from variational distribution using unpacked parameters</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;gate&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">gate_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">gate_params</span><span class="p">))</span></div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Negative Binomial with variable capture probability</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="nbvcp_model">
<a class="viewcode-back" href="../../api/models.html#scribe.models.nbvcp_model">[docs]</a>
<span class="k">def</span> <span class="nf">nbvcp_model</span><span class="p">(</span>
    <span class="n">n_cells</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_genes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Numpyro model for Negative Binomial with variable mRNA capture probability.</span>

<span class="sd">    This model assumes that each gene&#39;s mRNA count follows a Negative Binomial</span>
<span class="sd">    distribution, but with a cell-specific mRNA capture probability that</span>
<span class="sd">    modifies the success probability parameter. The model structure is:</span>
<span class="sd">        1. Each gene has a base success probability p and dispersion r</span>
<span class="sd">        2. Each cell has a capture probability p_capture</span>
<span class="sd">        3. The effective success probability for each gene in each cell is</span>
<span class="sd">           computed as p_hat = p * p_capture / (1 - p * (1 - p_capture)). This comes</span>
<span class="sd">           from the composition of a negative binomial distribution with a</span>
<span class="sd">           binomial distribution.</span>
<span class="sd">        4. Counts are drawn from NB(r, p_hat)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_cells : int</span>
<span class="sd">        Number of cells in the dataset</span>
<span class="sd">    n_genes : int</span>
<span class="sd">        Number of genes in the dataset</span>
<span class="sd">    model_config : ModelConfig</span>
<span class="sd">        Configuration object containing prior distributions for model parameters:</span>
<span class="sd">        - p_distribution_model: Prior for success probability p</span>
<span class="sd">        - r_distribution_model: Prior for dispersion parameters r</span>
<span class="sd">        - p_capture_distribution_model: Prior for capture probabilities p_capture</span>
<span class="sd">    counts : array-like, optional</span>
<span class="sd">        Observed counts matrix of shape (n_cells, n_genes). If None, generates</span>
<span class="sd">        samples from the prior.</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        Mini-batch size for stochastic variational inference. If None, uses full</span>
<span class="sd">        dataset.</span>

<span class="sd">    Model Structure</span>
<span class="sd">    --------------</span>
<span class="sd">    Global Parameters:</span>
<span class="sd">        - Success probability p ~ model_config.p_distribution_model</span>
<span class="sd">        - Gene-specific dispersion r ~ model_config.r_distribution_model</span>

<span class="sd">    Local Parameters:</span>
<span class="sd">        - Cell-specific capture probabilities p_capture ~ model_config.p_capture_distribution_model</span>
<span class="sd">        - Effective probability p_hat = p * p_capture / (1 - p * (1 - p_capture))</span>

<span class="sd">    Likelihood:</span>
<span class="sd">        - counts ~ NegativeBinomial(r, p_hat)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define global parameters</span>
    <span class="c1"># Sample base success probability</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_model</span><span class="p">)</span>

    <span class="c1"># Sample gene-specific dispersion parameters</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_model</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">n_genes</span><span class="p">]))</span>

    <span class="c1"># If we have observed data, condition on it</span>
    <span class="k">if</span> <span class="n">counts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If batch size is not provided, use the entire dataset</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
                <span class="c1"># Sample cell-specific capture probabilities</span>
                <span class="n">p_capture</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;p_capture&quot;</span><span class="p">,</span>
                    <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_model</span>
                <span class="p">)</span>

                <span class="c1"># Reshape p_capture for broadcasting and compute effective</span>
                <span class="c1"># probability given shared p</span>
                <span class="n">p_capture_reshaped</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">p_hat</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
                    <span class="s2">&quot;p_hat&quot;</span><span class="p">,</span>
                    <span class="n">p</span> <span class="o">*</span> <span class="n">p_capture_reshaped</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_capture_reshaped</span><span class="p">))</span>
                <span class="p">)</span>

                <span class="c1"># Condition on observed counts</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;counts&quot;</span><span class="p">,</span> 
                    <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p_hat</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> 
                    <span class="n">obs</span><span class="o">=</span><span class="n">counts</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span>
                <span class="s2">&quot;cells&quot;</span><span class="p">,</span>
                <span class="n">n_cells</span><span class="p">,</span>
                <span class="n">subsample_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">idx</span><span class="p">:</span>
                <span class="c1"># Sample cell-specific capture probabilities</span>
                <span class="n">p_capture</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;p_capture&quot;</span><span class="p">,</span>
                    <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_model</span>
                <span class="p">)</span>

                <span class="c1"># Reshape p_capture for broadcasting and compute effective probability</span>
                <span class="n">p_capture_reshaped</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">p_hat</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
                    <span class="s2">&quot;p_hat&quot;</span><span class="p">,</span>
                    <span class="n">p</span> <span class="o">*</span> <span class="n">p_capture_reshaped</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_capture_reshaped</span><span class="p">))</span>
                <span class="p">)</span>

                <span class="c1"># Condition on observed counts</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;counts&quot;</span><span class="p">,</span> 
                    <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p_hat</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> 
                    <span class="n">obs</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Predictive model (no obs)</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
            <span class="c1"># Sample cell-specific capture probabilities</span>
            <span class="n">p_capture</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="s2">&quot;p_capture&quot;</span><span class="p">,</span>
                <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_model</span>
            <span class="p">)</span>

            <span class="c1"># Reshape p_capture for broadcasting and compute effective probability</span>
            <span class="n">p_capture_reshaped</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">p_hat</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
                <span class="s2">&quot;p_hat&quot;</span><span class="p">,</span>
                <span class="n">p</span> <span class="o">*</span> <span class="n">p_capture_reshaped</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_capture_reshaped</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c1"># Sample counts</span>
            <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="s2">&quot;counts&quot;</span><span class="p">,</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p_hat</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span></div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Beta-Gamma-Beta Variational Posterior for Negative Binomial with variable</span>
<span class="c1"># capture probability</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="nbvcp_guide">
<a class="viewcode-back" href="../../api/models.html#scribe.models.nbvcp_guide">[docs]</a>
<span class="k">def</span> <span class="nf">nbvcp_guide</span><span class="p">(</span>
    <span class="n">n_cells</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_genes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Variational guide (approximate posterior) for the Negative Binomial model</span>
<span class="sd">    with variable capture probability.</span>

<span class="sd">    This guide specifies a factorized variational distribution that approximates</span>
<span class="sd">    the true posterior. The variational parameters are initialized using the</span>
<span class="sd">    distributions specified in model_config.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_cells : int</span>
<span class="sd">        Number of cells in the dataset</span>
<span class="sd">    n_genes : int</span>
<span class="sd">        Number of genes in the dataset</span>
<span class="sd">    model_config : ModelConfig</span>
<span class="sd">        Configuration object containing the variational distribution</span>
<span class="sd">        specifications:</span>
<span class="sd">            - p_distribution_guide: Distribution for success probability p</span>
<span class="sd">            - r_distribution_guide: Distribution for dispersion parameters r</span>
<span class="sd">            - p_capture_distribution_guide: Distribution for capture</span>
<span class="sd">              probabilities</span>
<span class="sd">    counts : array-like, optional</span>
<span class="sd">        Observed counts matrix of shape (n_cells, n_genes). Not directly used in</span>
<span class="sd">        the guide but included for API consistency with the model</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        Mini-batch size for stochastic variational inference. If provided, only</span>
<span class="sd">        updates a random subset of cells in each iteration</span>

<span class="sd">    Guide Structure</span>
<span class="sd">    --------------</span>
<span class="sd">    Variational Parameters:</span>
<span class="sd">        - Success probability p ~ model_config.p_distribution_guide</span>
<span class="sd">        - Gene-specific dispersion r ~ model_config.r_distribution_guide</span>
<span class="sd">        - Cell-specific capture probability p_capture ~</span>
<span class="sd">          model_config.p_capture_distribution_guide</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract p distribution values</span>
    <span class="n">p_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract p distribution parameters and constraints</span>
    <span class="n">p_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">p_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">p_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">p_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;p_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">p_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>

    <span class="c1"># Extract r distribution values</span>
    <span class="n">r_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract r distribution parameters and constraints </span>
    <span class="n">r_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">r_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">r_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">r_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;r_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_genes</span><span class="p">)</span> <span class="o">*</span> <span class="n">r_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>

    <span class="c1"># Sample p from variational distribution using unpacked parameters</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">p_params</span><span class="p">))</span>
    <span class="c1"># Sample r from variational distribution using unpacked parameters</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">r_params</span><span class="p">))</span>

    <span class="c1"># Extract p_capture distribution values</span>
    <span class="n">p_capture_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract p_capture distribution parameters and constraints</span>
    <span class="n">p_capture_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">p_capture_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">p_capture_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">p_capture_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;p_capture_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span> <span class="o">*</span> <span class="n">p_capture_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>

    <span class="c1"># Use plate for handling local parameters (p_capture)</span>
    <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
            <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="s2">&quot;p_capture&quot;</span><span class="p">,</span> 
                <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">p_capture_params</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span>
            <span class="s2">&quot;cells&quot;</span><span class="p">,</span>
            <span class="n">n_cells</span><span class="p">,</span>
            <span class="n">subsample_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">idx</span><span class="p">:</span>
            <span class="c1"># Index the parameters before creating the distribution</span>
            <span class="n">batch_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">param</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">p_capture_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="s2">&quot;p_capture&quot;</span><span class="p">,</span>
                <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">batch_params</span><span class="p">)</span>
            <span class="p">)</span></div>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Zero-Inflated Negative Binomial with variable capture probability</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="zinbvcp_model">
<a class="viewcode-back" href="../../api/models.html#scribe.models.zinbvcp_model">[docs]</a>
<span class="k">def</span> <span class="nf">zinbvcp_model</span><span class="p">(</span>
    <span class="n">n_cells</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_genes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Numpyro model for Zero-Inflated Negative Binomial with variable mRNA capture</span>
<span class="sd">    probability.</span>

<span class="sd">    This model combines the zero-inflation mechanism with variable capture</span>
<span class="sd">    probability. The model structure is:</span>
<span class="sd">        1. Each gene has a base success probability p and dispersion r</span>
<span class="sd">        2. Each cell has a capture probability p_capture</span>
<span class="sd">        3. Each gene has a dropout probability (gate)</span>
<span class="sd">        4. The effective success probability for each gene in each cell is</span>
<span class="sd">           computed as p_hat = p * p_capture / (1 - p * (1 - p_capture)). This</span>
<span class="sd">           comes from the composition of a negative binomial distribution with a</span>
<span class="sd">           binomial distribution.</span>
<span class="sd">        5. Counts are drawn from ZINB(r, p_hat, gate)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_cells : int</span>
<span class="sd">        Number of cells in the dataset</span>
<span class="sd">    n_genes : int</span>
<span class="sd">        Number of genes in the dataset</span>
<span class="sd">    model_config : ModelConfig</span>
<span class="sd">        Configuration object containing prior distributions for model</span>
<span class="sd">        parameters:</span>
<span class="sd">            - p_distribution_model: Prior for success probability p</span>
<span class="sd">            - r_distribution_model: Prior for dispersion parameters r</span>
<span class="sd">            - gate_distribution_model: Prior for dropout probabilities</span>
<span class="sd">            - p_capture_distribution_model: Prior for capture probabilities</span>
<span class="sd">    counts : array-like, optional</span>
<span class="sd">        Observed counts matrix of shape (n_cells, n_genes). If None, generates</span>
<span class="sd">        samples from the prior.</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        Mini-batch size for stochastic variational inference. If None, uses full</span>
<span class="sd">        dataset.</span>

<span class="sd">    Model Structure</span>
<span class="sd">    --------------</span>
<span class="sd">    Global Parameters:</span>
<span class="sd">        - Success probability p ~ model_config.p_distribution_model</span>
<span class="sd">        - Gene-specific dispersion r ~ model_config.r_distribution_model</span>
<span class="sd">        - Gene-specific dropout probabilities gate ~</span>
<span class="sd">          model_config.gate_distribution_model</span>

<span class="sd">    Local Parameters:</span>
<span class="sd">        - Cell-specific capture probabilities p_capture ~</span>
<span class="sd">          model_config.p_capture_distribution_model</span>
<span class="sd">        - Effective probability p_hat = p * p_capture / (1 - p * (1 -</span>
<span class="sd">          p_capture))</span>

<span class="sd">    Likelihood:</span>
<span class="sd">        - counts ~ ZeroInflatedNegativeBinomial(r, p_hat, gate)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define global parameters</span>
    <span class="c1"># Sample base success probability</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_model</span><span class="p">)</span>

    <span class="c1"># Sample gene-specific dispersion parameters</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_model</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">n_genes</span><span class="p">]))</span>

    <span class="c1"># Sample gate (dropout) parameters for all genes simultaneously</span>
    <span class="n">gate</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;gate&quot;</span><span class="p">,</span> 
        <span class="n">model_config</span><span class="o">.</span><span class="n">gate_distribution_model</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="n">n_genes</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># If we have observed data, condition on it</span>
    <span class="k">if</span> <span class="n">counts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If batch size is not provided, use the entire dataset</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
                <span class="c1"># Sample cell-specific capture probabilities</span>
                <span class="n">p_capture</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;p_capture&quot;</span><span class="p">,</span>
                    <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_model</span>
                <span class="p">)</span>

                <span class="c1"># Reshape p_capture for broadcasting and compute effective</span>
                <span class="c1"># probability</span>
                <span class="n">p_capture_reshaped</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">p_hat</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
                    <span class="s2">&quot;p_hat&quot;</span><span class="p">,</span>
                    <span class="n">p</span> <span class="o">*</span> <span class="n">p_capture_reshaped</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_capture_reshaped</span><span class="p">))</span>
                <span class="p">)</span>

                <span class="c1"># Create base negative binomial distribution with adjusted</span>
                <span class="c1"># probabilities</span>
                <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p_hat</span><span class="p">)</span>
                <span class="c1"># Create zero-inflated distribution</span>
                <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span>
                    <span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Likelihood for the counts - one for each cell</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">zinb</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">counts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span>
                <span class="s2">&quot;cells&quot;</span><span class="p">,</span>
                <span class="n">n_cells</span><span class="p">,</span>
                <span class="n">subsample_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">idx</span><span class="p">:</span>
                <span class="c1"># Sample cell-specific capture probabilities</span>
                <span class="n">p_capture</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;p_capture&quot;</span><span class="p">,</span>
                    <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_model</span>
                <span class="p">)</span>

                <span class="c1"># Reshape p_capture for broadcasting and compute effective</span>
                <span class="c1"># probability</span>
                <span class="n">p_capture_reshaped</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">p_hat</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
                    <span class="s2">&quot;p_hat&quot;</span><span class="p">,</span>
                    <span class="n">p</span> <span class="o">*</span> <span class="n">p_capture_reshaped</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_capture_reshaped</span><span class="p">))</span>
                <span class="p">)</span>

                <span class="c1"># Create base negative binomial distribution with adjusted</span>
                <span class="c1"># probabilities</span>
                <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p_hat</span><span class="p">)</span>
                <span class="c1"># Create zero-inflated distribution</span>
                <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span>
                    <span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Likelihood for the counts - one for each cell</span>
                <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">zinb</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Predictive model (no obs)</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
            <span class="c1"># Sample cell-specific capture probabilities</span>
            <span class="n">p_capture</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="s2">&quot;p_capture&quot;</span><span class="p">,</span>
                <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_model</span>
            <span class="p">)</span>

            <span class="c1"># Reshape p_capture for broadcasting and compute effective</span>
            <span class="c1"># probability</span>
            <span class="n">p_capture_reshaped</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">p_hat</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
                <span class="s2">&quot;p_hat&quot;</span><span class="p">,</span>
                <span class="n">p</span> <span class="o">*</span> <span class="n">p_capture_reshaped</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_capture_reshaped</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c1"># Create base negative binomial distribution with adjusted</span>
            <span class="c1"># probabilities</span>
            <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p_hat</span><span class="p">)</span>
            <span class="c1"># Create zero-inflated distribution</span>
            <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span>
                <span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Sample counts</span>
            <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">zinb</span><span class="p">)</span></div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Beta-Gamma-Beta Variational Posterior for Zero-Inflated Negative Binomial with</span>
<span class="c1"># variable capture probability</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="zinbvcp_guide">
<a class="viewcode-back" href="../../api/models.html#scribe.models.zinbvcp_guide">[docs]</a>
<span class="k">def</span> <span class="nf">zinbvcp_guide</span><span class="p">(</span>
    <span class="n">n_cells</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_genes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
    <span class="n">counts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Variational guide (approximate posterior) for the Zero-Inflated Negative</span>
<span class="sd">    Binomial model with variable capture probability.</span>

<span class="sd">    This guide specifies a factorized variational distribution that approximates</span>
<span class="sd">    the true posterior:</span>
<span class="sd">        1. A Beta distribution for the global success probability p</span>
<span class="sd">        2. Independent Gamma distributions for each gene&#39;s dispersion parameter</span>
<span class="sd">           r</span>
<span class="sd">        3. Independent Beta distributions for each gene&#39;s dropout probability</span>
<span class="sd">           (gate)</span>
<span class="sd">        4. Independent Beta distributions for each cell&#39;s capture probability</span>
<span class="sd">           p_capture</span>

<span class="sd">    The variational parameters are:</span>
<span class="sd">        - alpha_p, beta_p: Parameters for p&#39;s Beta distribution</span>
<span class="sd">        - alpha_r, beta_r: Parameters for each gene&#39;s Gamma distribution (shape:</span>
<span class="sd">          n_genes)</span>
<span class="sd">        - alpha_gate, beta_gate: Parameters for each gene&#39;s Beta distribution</span>
<span class="sd">          (shape: n_genes)</span>
<span class="sd">        - alpha_p_capture, beta_p_capture: Parameters for each cell&#39;s Beta</span>
<span class="sd">          distribution (shape: n_cells)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_cells : int</span>
<span class="sd">        Number of cells in the dataset</span>
<span class="sd">    n_genes : int</span>
<span class="sd">        Number of genes in the dataset</span>
<span class="sd">    p_prior : tuple of float, default=(1, 1)</span>
<span class="sd">        Parameters (alpha, beta) for initializing the Beta variational</span>
<span class="sd">        distribution of the global success probability p</span>
<span class="sd">    r_prior : tuple of float, default=(2, 0.1)</span>
<span class="sd">        Parameters (shape, rate) for initializing the Gamma variational</span>
<span class="sd">        distributions of gene-specific dispersion parameters</span>
<span class="sd">    p_capture_prior : tuple of float, default=(1, 1)</span>
<span class="sd">        Parameters (alpha, beta) for initializing the Beta variational</span>
<span class="sd">        distributions of cell-specific capture probabilities</span>
<span class="sd">    gate_prior : tuple of float, default=(1, 1)</span>
<span class="sd">        Parameters (alpha, beta) for initializing the Beta variational</span>
<span class="sd">        distributions of gene-specific dropout probabilities</span>
<span class="sd">    counts : array-like, optional</span>
<span class="sd">        Observed counts matrix of shape (n_cells, n_genes). Not directly used in</span>
<span class="sd">        the guide but included for API consistency with the model</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        Mini-batch size for stochastic variational inference. If provided, only</span>
<span class="sd">        updates a random subset of cells in each iteration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract p distribution values</span>
    <span class="n">p_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract p distribution parameters and constraints</span>
    <span class="n">p_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">p_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">p_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">p_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;p_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">p_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>

    <span class="c1"># Extract r distribution values</span>
    <span class="n">r_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract r distribution parameters and constraints </span>
    <span class="n">r_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">r_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">r_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">r_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;r_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_genes</span><span class="p">)</span> <span class="o">*</span> <span class="n">r_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>

    <span class="c1"># Extract gate distribution values</span>
    <span class="n">gate_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">gate_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract gate distribution parameters and constraints</span>
    <span class="n">gate_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">gate_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">gate_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">gate_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">gate_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;gate_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_genes</span><span class="p">)</span> <span class="o">*</span> <span class="n">gate_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>
    
    <span class="c1"># Sample p from variational distribution using unpacked parameters</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">p_params</span><span class="p">))</span>
    <span class="c1"># Sample r from variational distribution using unpacked parameters</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">r_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">r_params</span><span class="p">))</span>
    <span class="c1"># Sample gate from variational distribution using unpacked parameters</span>
    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;gate&quot;</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">gate_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">gate_params</span><span class="p">))</span>

    <span class="c1"># Extract p_capture distribution values</span>
    <span class="n">p_capture_values</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_guide</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>
    <span class="c1"># Extract p_capture distribution parameters and constraints</span>
    <span class="n">p_capture_constraints</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_guide</span><span class="o">.</span><span class="n">arg_constraints</span>
    <span class="c1"># Initialize parameters for each constraint in the distribution</span>
    <span class="n">p_capture_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop through each constraint in the distribution</span>
    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">p_capture_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">p_capture_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;p_capture_</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span> <span class="o">*</span> <span class="n">p_capture_values</span><span class="p">[</span><span class="n">param_name</span><span class="p">],</span>
            <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span>
        <span class="p">)</span>

    <span class="c1"># Use plate for handling local parameters (p_capture)</span>
    <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">):</span>
            <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="s2">&quot;p_capture&quot;</span><span class="p">,</span> 
                <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">p_capture_params</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span>
            <span class="s2">&quot;cells&quot;</span><span class="p">,</span>
            <span class="n">n_cells</span><span class="p">,</span>
            <span class="n">subsample_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">idx</span><span class="p">:</span>
            <span class="c1"># Index the parameters before creating the distribution</span>
            <span class="n">batch_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">param</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">p_capture_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="s2">&quot;p_capture&quot;</span><span class="p">,</span>
                <span class="n">model_config</span><span class="o">.</span><span class="n">p_capture_distribution_guide</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">batch_params</span><span class="p">)</span>
            <span class="p">)</span></div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Log Likelihood functions</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Negative Binomial-Dirichlet Multinomial (NBDM) likelihood</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="nbdm_log_likelihood">
<a class="viewcode-back" href="../../api/models.html#scribe.models.nbdm_log_likelihood">[docs]</a>
<span class="k">def</span> <span class="nf">nbdm_log_likelihood</span><span class="p">(</span>
    <span class="n">counts</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> 
    <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cells_axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">return_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute log likelihood for NBDM model using plates.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    counts : jnp.ndarray</span>
<span class="sd">        Array of shape (n_cells, n_genes) containing observed counts</span>
<span class="sd">    params : Dict</span>
<span class="sd">        Dictionary containing model parameters: </span>
<span class="sd">            - &#39;p&#39;: success probability parameter (scalar)</span>
<span class="sd">            - &#39;r&#39;: dispersion parameters for each gene (vector of length n_genes)</span>
<span class="sd">    batch_size : Optional[int]</span>
<span class="sd">        Size of mini-batches for stochastic computation. If None, uses full dataset.</span>
<span class="sd">    cells_axis: int = 0</span>
<span class="sd">        Axis along which cells are arranged. 0 means cells are rows (default),</span>
<span class="sd">        1 means cells are columns</span>
<span class="sd">    return_by: str</span>
<span class="sd">        Specifies how to return the log probabilities. Must be one of:</span>
<span class="sd">            - &#39;cell&#39;: returns log probabilities using the NBDM model (default)</span>
<span class="sd">            - &#39;gene&#39;: returns log probabilities using independent NB per gene</span>
<span class="sd">    dtype: jnp.dtype, default=jnp.float32</span>
<span class="sd">        Data type for numerical precision in computations</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    jnp.ndarray</span>
<span class="sd">        Array of log likelihood values. Shape depends on return_by:</span>
<span class="sd">            - &#39;cell&#39;: shape (n_cells,)</span>
<span class="sd">            - &#39;gene&#39;: shape (n_genes,)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check return_by</span>
    <span class="k">if</span> <span class="n">return_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;return_by must be one of [&#39;cell&#39;, &#39;gene&#39;]&quot;</span><span class="p">)</span>

    <span class="c1"># Extract parameters from dictionary - handle both old and new formats</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">r_total</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    
    <span class="c1"># Extract dimensions</span>
    <span class="k">if</span> <span class="n">cells_axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n_cells</span><span class="p">,</span> <span class="n">n_genes</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_genes</span><span class="p">,</span> <span class="n">n_cells</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Transpose to make cells rows</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_by</span> <span class="o">==</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span>
        <span class="c1"># Compute total counts for each cell</span>
        <span class="n">total_counts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># If no batch size provided, process all cells at once</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Compute log probability for total counts</span>
            <span class="n">log_prob_total</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span>
                <span class="n">r_total</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">total_counts</span><span class="p">)</span>
            <span class="c1"># Compute log probability for each gene</span>
            <span class="n">log_prob_genes</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">DirichletMultinomial</span><span class="p">(</span>
                <span class="n">r</span><span class="p">,</span> <span class="n">total_count</span><span class="o">=</span><span class="n">total_counts</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
            <span class="c1"># Return sum of log probabilities</span>
            <span class="k">return</span> <span class="n">log_prob_total</span> <span class="o">+</span> <span class="n">log_prob_genes</span>
        
        <span class="c1"># Initialize array to store per-cell log probabilities</span>
        <span class="n">cell_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span>

        <span class="c1"># Process in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">n_cells</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># Get indices for current batch</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
            
            <span class="c1"># Get batch data</span>
            <span class="n">batch_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="n">batch_total_counts</span> <span class="o">=</span> <span class="n">total_counts</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            
            <span class="c1"># Compute log probability for total counts</span>
            <span class="n">batch_log_prob_total</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span>
                <span class="n">r_total</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch_total_counts</span><span class="p">)</span>
            <span class="c1"># Compute log probability for each gene</span>
            <span class="n">batch_log_prob_genes</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">DirichletMultinomial</span><span class="p">(</span>
                <span class="n">r</span><span class="p">,</span> <span class="n">total_count</span><span class="o">=</span><span class="n">batch_total_counts</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch_counts</span><span class="p">)</span>
            
            <span class="c1"># Store batch log probabilities</span>
            <span class="n">cell_log_probs</span> <span class="o">=</span> <span class="n">cell_log_probs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">batch_log_prob_total</span> <span class="o">+</span> <span class="n">batch_log_prob_genes</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cell_log_probs</span>
    
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># return_by == &#39;gene&#39;</span>
        <span class="c1"># For per-gene likelihood, use independent negative binomials</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Compute log probabilities for all genes at once</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># Sum over cells</span>
            <span class="p">)</span>
        
        <span class="c1"># Initialize array to store per-gene log probabilities</span>
        <span class="n">gene_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_genes</span><span class="p">)</span>
        
        <span class="c1"># Process in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">n_cells</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
            
            <span class="c1"># Get batch data</span>
            <span class="n">batch_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            
            <span class="c1"># Create NB distribution and compute log probs for each gene</span>
            <span class="n">nb_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="c1"># Shape of batch_counts is (batch_size, n_genes)</span>
            <span class="c1"># We want log probs for each gene summed over the batch</span>
            <span class="c1"># Shape: (batch_size, n_genes)</span>
            <span class="n">batch_log_probs</span> <span class="o">=</span> <span class="n">nb_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch_counts</span><span class="p">)</span>  
            
            <span class="c1"># Add the batch contribution to the running total</span>
            <span class="n">gene_log_probs</span> <span class="o">+=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">batch_log_probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">gene_log_probs</span></div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Zero-Inflated Negative Binomial (ZINB) likelihood</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="zinb_log_likelihood">
<a class="viewcode-back" href="../../api/models.html#scribe.models.zinb_log_likelihood">[docs]</a>
<span class="k">def</span> <span class="nf">zinb_log_likelihood</span><span class="p">(</span>
    <span class="n">counts</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> 
    <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cells_axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">return_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute log likelihood for Zero-Inflated Negative Binomial model.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    counts : jnp.ndarray</span>
<span class="sd">        Array of shape (n_cells, n_genes) containing observed counts</span>
<span class="sd">    params : Dict</span>
<span class="sd">        Dictionary containing model parameters:</span>
<span class="sd">            - &#39;p&#39;: success probability parameter</span>
<span class="sd">            - &#39;r&#39;: dispersion parameters for each gene</span>
<span class="sd">            - &#39;gate&#39;: dropout probability parameter</span>
<span class="sd">    batch_size : Optional[int]</span>
<span class="sd">        Size of mini-batches for stochastic computation. If None, uses full</span>
<span class="sd">        dataset.</span>
<span class="sd">    cells_axis: int = 0</span>
<span class="sd">        Axis along which cells are arranged. 0 means cells are rows (default),</span>
<span class="sd">        1 means cells are columns</span>
<span class="sd">    return_by: str</span>
<span class="sd">        Specifies how to return the log probabilities. Must be one of:</span>
<span class="sd">            - &#39;cell&#39;: returns log probabilities summed over genes (default)</span>
<span class="sd">            - &#39;gene&#39;: returns log probabilities summed over cells</span>
<span class="sd">    dtype: jnp.dtype, default=jnp.float32</span>
<span class="sd">        Data type for numerical precision in computations</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    jnp.ndarray</span>
<span class="sd">        Array of log likelihood values. Shape depends on return_by:</span>
<span class="sd">            - &#39;cell&#39;: shape (n_cells,)</span>
<span class="sd">            - &#39;gene&#39;: shape (n_genes,)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">return_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;return_by must be one of [&#39;cell&#39;, &#39;gene&#39;]&quot;</span><span class="p">)</span>

    <span class="c1"># Extract parameters from dictionary</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">gate</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;gate&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="c1"># Extract dimensions</span>
    <span class="k">if</span> <span class="n">cells_axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n_cells</span><span class="p">,</span> <span class="n">n_genes</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_genes</span><span class="p">,</span> <span class="n">n_cells</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Transpose to make cells rows</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
       
    <span class="k">if</span> <span class="n">return_by</span> <span class="o">==</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span>
        <span class="c1"># If no batch size provided, process all cells at once</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create base Negative Binomial distribution</span>
            <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="c1"># Create Zero-Inflated distribution</span>
            <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span>
                <span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Return per-cell log probabilities</span>
            <span class="k">return</span> <span class="n">zinb</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
        
        <span class="c1"># Initialize array to store per-cell log probabilities</span>
        <span class="n">cell_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span>
        
        <span class="c1"># Process in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">n_cells</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># Get indices for current batch</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
            
            <span class="c1"># Get batch data</span>
            <span class="n">batch_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            
            <span class="c1"># Create base Negative Binomial distribution</span>
            <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="c1"># Create Zero-Inflated distribution</span>
            <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span>
                <span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Store batch log probabilities</span>
            <span class="n">cell_log_probs</span> <span class="o">=</span> <span class="n">cell_log_probs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">zinb</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch_counts</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cell_log_probs</span>
    
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># return_by == &#39;gene&#39;</span>
        <span class="c1"># For per-gene likelihood</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create base distribution and compute all at once</span>
            <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span><span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">zinb</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Initialize array to store per-gene log probabilities</span>
        <span class="n">gene_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_genes</span><span class="p">)</span>
        
        <span class="c1"># Process in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">n_cells</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># Get indices for current batch</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
            
            <span class="c1"># Get batch data</span>
            <span class="n">batch_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            
            <span class="c1"># Create distributions and compute log probs</span>
            <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span><span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span>
            <span class="c1"># Shape: (batch_size, n_genes)</span>
            <span class="n">batch_log_probs</span> <span class="o">=</span> <span class="n">zinb</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch_counts</span><span class="p">)</span>  
            
            <span class="c1"># Add the batch contribution to the running total</span>
            <span class="n">gene_log_probs</span> <span class="o">+=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">batch_log_probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">gene_log_probs</span></div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Negative Binomial with Variable Capture Probability (NBVC) likelihood</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="nbvcp_log_likelihood">
<a class="viewcode-back" href="../../api/models.html#scribe.models.nbvcp_log_likelihood">[docs]</a>
<span class="k">def</span> <span class="nf">nbvcp_log_likelihood</span><span class="p">(</span>
    <span class="n">counts</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> 
    <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cells_axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">return_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute log likelihood for Negative Binomial with Variable Capture</span>
<span class="sd">    Probability.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    counts : jnp.ndarray</span>
<span class="sd">        Array of shape (n_cells, n_genes) containing observed counts</span>
<span class="sd">    params : Dict</span>
<span class="sd">        Dictionary containing model parameters:</span>
<span class="sd">            - &#39;p&#39;: base success probability parameter</span>
<span class="sd">            - &#39;r&#39;: dispersion parameters for each gene</span>
<span class="sd">            - &#39;p_capture&#39;: cell-specific capture probabilities</span>
<span class="sd">    batch_size : Optional[int]</span>
<span class="sd">        Size of mini-batches for stochastic computation. If None, uses full</span>
<span class="sd">        dataset.</span>
<span class="sd">    cells_axis: int = 0</span>
<span class="sd">        Axis along which cells are arranged. 0 means cells are rows (default), 1</span>
<span class="sd">        means cells are columns</span>
<span class="sd">    return_by: str</span>
<span class="sd">        Specifies how to return the log probabilities. Must be one of:</span>
<span class="sd">            - &#39;cell&#39;: returns log probabilities summed over genes (default)</span>
<span class="sd">            - &#39;gene&#39;: returns log probabilities summed over cells</span>
<span class="sd">    dtype: jnp.dtype, default=jnp.float32</span>
<span class="sd">        Data type for numerical precision in computations</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    jnp.ndarray</span>
<span class="sd">        Array of log likelihood values. Shape depends on return_by:</span>
<span class="sd">            - &#39;cell&#39;: shape (n_cells,)</span>
<span class="sd">            - &#39;gene&#39;: shape (n_genes,)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check return_by</span>
    <span class="k">if</span> <span class="n">return_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;return_by must be one of [&#39;cell&#39;, &#39;gene&#39;]&quot;</span><span class="p">)</span>

    <span class="c1"># Extract parameters from dictionary</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">p_capture</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;p_capture&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="c1"># Extract dimensions</span>
    <span class="k">if</span> <span class="n">cells_axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n_cells</span><span class="p">,</span> <span class="n">n_genes</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_genes</span><span class="p">,</span> <span class="n">n_cells</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Transpose to make cells rows</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_by</span> <span class="o">==</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span>
        <span class="c1"># If no batch size provided, process all cells at once</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Reshape p_capture to [n_cells, 1] for broadcasting</span>
            <span class="n">p_capture_reshaped</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Compute p_hat for all cells</span>
            <span class="n">p_hat</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_capture_reshaped</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_capture_reshaped</span><span class="p">))</span>
            <span class="c1"># Return per-cell log probabilities</span>
            <span class="k">return</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span>
                <span class="n">r</span><span class="p">,</span> <span class="n">p_hat</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
        
        <span class="c1"># Initialize array to store per-cell log probabilities</span>
        <span class="n">cell_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span>
        
        <span class="c1"># Process in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">n_cells</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
            
            <span class="c1"># Get batch data</span>
            <span class="n">batch_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="n">batch_p_capture</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            
            <span class="c1"># Reshape batch_p_capture for broadcasting</span>
            <span class="n">batch_p_capture</span> <span class="o">=</span> <span class="n">batch_p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Compute p_hat for batch</span>
            <span class="n">batch_p_hat</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">batch_p_capture</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">batch_p_capture</span><span class="p">))</span>
            <span class="c1"># Store batch log probabilities</span>
            <span class="n">cell_log_probs</span> <span class="o">=</span> <span class="n">cell_log_probs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">batch_p_hat</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch_counts</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cell_log_probs</span>
    
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># return_by == &#39;gene&#39;</span>
        <span class="c1"># For per-gene likelihood</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Reshape p_capture to [n_cells, 1] for broadcasting</span>
            <span class="n">p_capture_reshaped</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Compute p_hat for all cells</span>
            <span class="n">p_hat</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_capture_reshaped</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_capture_reshaped</span><span class="p">))</span>
            <span class="c1"># Compute log probabilities for each gene</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p_hat</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># Sum over cells</span>
            <span class="p">)</span>
        
        <span class="c1"># Initialize array to store per-gene log probabilities</span>
        <span class="n">gene_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_genes</span><span class="p">)</span>
        
        <span class="c1"># Process in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">n_cells</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
            
            <span class="c1"># Get batch data</span>
            <span class="n">batch_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="n">batch_p_capture</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            
            <span class="c1"># Reshape batch_p_capture for broadcasting</span>
            <span class="n">batch_p_capture</span> <span class="o">=</span> <span class="n">batch_p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Compute p_hat for batch</span>
            <span class="n">batch_p_hat</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">batch_p_capture</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">batch_p_capture</span><span class="p">))</span>
            <span class="c1"># Compute log probabilities for batch</span>
            <span class="n">batch_log_probs</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span>
                <span class="n">r</span><span class="p">,</span> <span class="n">batch_p_hat</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch_counts</span><span class="p">)</span>
            
            <span class="c1"># Add the batch contribution to the running total</span>
            <span class="n">gene_log_probs</span> <span class="o">+=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">batch_log_probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">gene_log_probs</span></div>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Zero-Inflated Negative Binomial with Variable Capture Probability (ZINBVC)</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="zinbvcp_log_likelihood">
<a class="viewcode-back" href="../../api/models.html#scribe.models.zinbvcp_log_likelihood">[docs]</a>
<span class="k">def</span> <span class="nf">zinbvcp_log_likelihood</span><span class="p">(</span>
    <span class="n">counts</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
    <span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> 
    <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cells_axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">return_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute log likelihood for Zero-Inflated Negative Binomial with Variable</span>
<span class="sd">    Capture Probability.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    counts : jnp.ndarray</span>
<span class="sd">        Array of shape (n_cells, n_genes) containing observed counts</span>
<span class="sd">    params : Dict</span>
<span class="sd">        Dictionary containing model parameters:</span>
<span class="sd">            - &#39;p&#39;: base success probability parameter</span>
<span class="sd">            - &#39;r&#39;: dispersion parameters for each gene</span>
<span class="sd">            - &#39;p_capture&#39;: cell-specific capture probabilities</span>
<span class="sd">            - &#39;gate&#39;: dropout probability parameter</span>
<span class="sd">    batch_size : Optional[int]</span>
<span class="sd">        Size of mini-batches for stochastic computation. If None, uses full</span>
<span class="sd">        dataset.</span>
<span class="sd">    cells_axis: int = 0</span>
<span class="sd">        Axis along which cells are arranged. 0 means cells are rows (default),</span>
<span class="sd">        1 means cells are columns</span>
<span class="sd">    return_by: str</span>
<span class="sd">        Specifies how to return the log probabilities. Must be one of:</span>
<span class="sd">            - &#39;cell&#39;: returns log probabilities summed over genes (default)</span>
<span class="sd">            - &#39;gene&#39;: returns log probabilities summed over cells</span>
<span class="sd">    dtype: jnp.dtype, default=jnp.float32</span>
<span class="sd">        Data type for numerical precision in computations</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    jnp.ndarray</span>
<span class="sd">        Array of log likelihood values. Shape depends on return_by:</span>
<span class="sd">            - &#39;cell&#39;: shape (n_cells,)</span>
<span class="sd">            - &#39;gene&#39;: shape (n_genes,)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check return_by</span>
    <span class="k">if</span> <span class="n">return_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;return_by must be one of [&#39;cell&#39;, &#39;gene&#39;]&quot;</span><span class="p">)</span>

    <span class="c1"># Extract parameters from dictionary</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">p_capture</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;p_capture&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">gate</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;gate&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="c1"># Extract dimensions</span>
    <span class="k">if</span> <span class="n">cells_axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">n_cells</span><span class="p">,</span> <span class="n">n_genes</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_genes</span><span class="p">,</span> <span class="n">n_cells</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Transpose to make cells rows</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
       
    <span class="k">if</span> <span class="n">return_by</span> <span class="o">==</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span>
        <span class="c1"># If no batch size provided, process all cells at once</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Reshape capture probabilities for broadcasting</span>
            <span class="n">p_capture_reshaped</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Compute adjusted success probability</span>
            <span class="n">p_hat</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_capture_reshaped</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_capture_reshaped</span><span class="p">))</span>
            <span class="c1"># Create base Negative Binomial distribution</span>
            <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p_hat</span><span class="p">)</span>
            <span class="c1"># Create Zero-Inflated distribution</span>
            <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span>
                <span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Return per-cell log probabilities</span>
            <span class="k">return</span> <span class="n">zinb</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
        
        <span class="c1"># Initialize array to store per-cell log probabilities</span>
        <span class="n">cell_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cells</span><span class="p">)</span>
        
        <span class="c1"># Process in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">n_cells</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
            
            <span class="c1"># Get batch data</span>
            <span class="n">batch_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="n">batch_p_capture</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            
            <span class="c1"># Reshape capture probabilities for broadcasting</span>
            <span class="n">batch_p_capture</span> <span class="o">=</span> <span class="n">batch_p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Compute adjusted success probability</span>
            <span class="n">batch_p_hat</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">batch_p_capture</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">batch_p_capture</span><span class="p">))</span>
            <span class="c1"># Create base Negative Binomial distribution</span>
            <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">batch_p_hat</span><span class="p">)</span>
            <span class="c1"># Create Zero-Inflated distribution</span>
            <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span>
                <span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Store batch log probabilities</span>
            <span class="n">cell_log_probs</span> <span class="o">=</span> <span class="n">cell_log_probs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">zinb</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch_counts</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">cell_log_probs</span>
    
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># return_by == &#39;gene&#39;</span>
        <span class="c1"># For per-gene likelihood</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Reshape capture probabilities for broadcasting</span>
            <span class="n">p_capture_reshaped</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Compute adjusted success probability</span>
            <span class="n">p_hat</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">p_capture_reshaped</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_capture_reshaped</span><span class="p">))</span>
            <span class="c1"># Create base distribution and compute all at once</span>
            <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p_hat</span><span class="p">)</span>
            <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span><span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">zinb</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Initialize array to store per-gene log probabilities</span>
        <span class="n">gene_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_genes</span><span class="p">)</span>
        
        <span class="c1"># Process in batches</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">n_cells</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">)</span>
            
            <span class="c1"># Get batch data</span>
            <span class="n">batch_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="n">batch_p_capture</span> <span class="o">=</span> <span class="n">p_capture</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            
            <span class="c1"># Reshape capture probabilities for broadcasting</span>
            <span class="n">batch_p_capture</span> <span class="o">=</span> <span class="n">batch_p_capture</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Compute adjusted success probability</span>
            <span class="n">batch_p_hat</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="p">(</span><span class="n">batch_p_capture</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">batch_p_capture</span><span class="p">))</span>
            <span class="c1"># Create distributions and compute log probs</span>
            <span class="n">base_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">batch_p_hat</span><span class="p">)</span>
            <span class="n">zinb</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ZeroInflatedDistribution</span><span class="p">(</span><span class="n">base_dist</span><span class="p">,</span> <span class="n">gate</span><span class="o">=</span><span class="n">gate</span><span class="p">)</span>
            <span class="n">batch_log_probs</span> <span class="o">=</span> <span class="n">zinb</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">batch_counts</span><span class="p">)</span>
            
            <span class="c1"># Add the batch contribution to the running total</span>
            <span class="n">gene_log_probs</span> <span class="o">+=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">batch_log_probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">gene_log_probs</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Manuel Razo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>