# @package _global_

# --- Defaults ---
defaults:
  - data: singer
  - inference: svi
  - optional model: null  # Power users can use model=zinb, model=nbvcp, etc.
  - viz: default
  - amortization@amortization.capture: null  # Optional: use 'capture' for amortized capture
  - _self_

# --- Data Loading ---
# path is now in conf/data

# --- Model Features ---
# These flags determine the model type automatically:
#   zero_inflation=false, variable_capture=false → nbdm (base model)
#   zero_inflation=true,  variable_capture=false → zinb (zero-inflated)
#   zero_inflation=false, variable_capture=true  → nbvcp (variable capture)
#   zero_inflation=true,  variable_capture=true  → zinbvcp (both)
zero_inflation: false    # Add zero-inflation gate (for excess zeros)
variable_capture: false  # Add cell-specific capture probability

# --- Model Configuration ---
# Power users can override the model directly: model=zinb, model=nbvcp, etc.
# This takes precedence over the feature flags above.

# Parameterization scheme
# - "canonical" (or "standard"): Sample p ~ Beta, r ~ LogNormal directly
# - "linked" (or "mean_prob"): Sample p ~ Beta, mu ~ LogNormal, derive r
# - "odds_ratio" (or "mean_odds"): Sample phi ~ BetaPrime, mu ~ LogNormal
parameterization: mean_odds

# Use unconstrained parameterization (Normal + transform)
unconstrained: false

# Mixture model configuration
# Set to integer >= 2 for mixture models, null for single component
n_components: null

# Which parameters should be component-specific in mixture models
# null = default (all gene-specific params), or list like ["r", "gate"]
mixture_params: null

# Guide configuration
# null = mean-field, integer = low-rank with that rank
guide_rank: null

# --- Priors Configuration (optional overrides) ---
# Each prior is a list [param1, param2] for the distribution
# - Beta priors: [alpha, beta]
# - LogNormal priors: [loc, scale]
# - BetaPrime priors: [alpha, beta]
priors:
  p: null           # Beta(alpha, beta) for success probability
  r: null           # LogNormal(loc, scale) for dispersion
  mu: null          # LogNormal(loc, scale) for mean (linked/odds_ratio)
  phi: null         # BetaPrime(alpha, beta) for odds ratio
  gate: null        # Beta(alpha, beta) for zero-inflation gate
  p_capture: null   # Beta(alpha, beta) for capture probability
  phi_capture: null # BetaPrime(alpha, beta) for capture odds
  mixing: null      # Dirichlet concentrations for mixture weights

# --- Amortization Configuration (for VCP models) ---
# Amortized inference uses a neural network to predict variational parameters
# from total UMI count instead of learning per-cell parameters.
# Only applies to nbvcp and zinbvcp models.
amortization:
  capture:
    enabled: false       # Enable amortized capture probability inference
    hidden_dims: [64, 32]  # MLP hidden layer dimensions
    activation: leaky_relu     # Activation: relu, gelu, silu, tanh, etc.

# --- General Settings ---
seed: 42

# Data Processing
cells_axis: 0
layer: null

# --- Output Configuration ---
# Optional custom output subdirectory (inside data directory)
# If set, overrides the auto-generated directory name from config overrides
output_dir: null

# --- Hydra settings ---
hydra:
  run:
    # Use output_dir if explicitly set by user, otherwise auto-generate from overrides
    # Note: We use 'model' in path to keep runs organized by model type
    # sanitize_dirname removes brackets [] which cause issues with Orbax checkpoint library
    dir: outputs/${data.name}/${model}/${inference.method}/${sanitize_dirname:${hydra:job.override_dirname}}
  job:
    name: ${data.name}_${inference.method}
    config:
      override_dirname:
        exclude_keys:
          - viz
          - viz.run_dir
          - viz.loss
          - viz.ecdf
          - viz.ppc
          - viz.umap
          - viz.heatmap
          - viz.mixture_ppc
          - viz.format
          - viz.ecdf_opts
          - viz.ppc_opts
          - viz.umap_opts
          - viz.heatmap_opts
          - viz.mixture_ppc_opts
          - output_dir
