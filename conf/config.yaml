# @package _global_

# --- Defaults ---
defaults:
  - data: ???  # Required: user must specify which dataset to use.
  - inference: svi
  - optional model: null  # Power users can use model=zinb, model=nbvcp, etc.
  - viz: default
  - amortization@amortization.capture: null  # Optional: use 'capture' for amortized capture
  - _self_

# --- Data Loading ---
# path is now in conf/data

# --- Model Features ---
# These flags determine the model type automatically:
#   zero_inflation=false, variable_capture=false → nbdm (base model)
#   zero_inflation=true,  variable_capture=false → zinb (zero-inflated)
#   zero_inflation=false, variable_capture=true  → nbvcp (variable capture)
#   zero_inflation=true,  variable_capture=true  → zinbvcp (both)
zero_inflation: false    # Add zero-inflation gate (for excess zeros)
variable_capture: false  # Add cell-specific capture probability

# --- Model Configuration ---
# Power users can override the model directly: model=zinb, model=nbvcp, etc.
# This takes precedence over the feature flags above.

# Parameterization scheme
# - "canonical" (or "standard"): Sample p ~ Beta, r ~ LogNormal directly
# - "linked" (or "mean_prob"): Sample p ~ Beta, mu ~ LogNormal, derive r
# - "odds_ratio" (or "mean_odds"): Sample phi ~ BetaPrime, mu ~ LogNormal
parameterization: mean_odds

# Use unconstrained parameterization (Normal + transform)
unconstrained: false

# Mixture model configuration
# Set to integer >= 2 for mixture models, null for single component.
# When annotation_key is provided and n_components is null, the number
# of components is automatically inferred from the unique labels.
n_components: null

# Which parameters should be component-specific in mixture models
# null = default (all sampled core params), or explicit list like ["r", "gate"]
mixture_params: null

# Guide configuration
# null = mean-field, integer = low-rank with that rank
guide_rank: null

# --- Priors Configuration (optional overrides) ---
# Each prior is a list [param1, param2] for the distribution
# - Beta priors: [alpha, beta]
# - LogNormal priors: [loc, scale]
# - BetaPrime priors: [alpha, beta]
priors:
  p: null           # Beta(alpha, beta) for success probability
  r: null           # LogNormal(loc, scale) for dispersion
  mu: null          # LogNormal(loc, scale) for mean (linked/odds_ratio)
  phi: null         # BetaPrime(alpha, beta) for odds ratio
  gate: null        # Beta(alpha, beta) for zero-inflation gate
  p_capture: null   # Beta(alpha, beta) for capture probability
  phi_capture: null # BetaPrime(alpha, beta) for capture odds
  mixing: null      # Dirichlet concentrations for mixture weights
                    # Accepts a list [a1, a2, ...] of length n_components,
                    # or a single scalar (e.g. 5.0) broadcast to all components.

# --- Amortization Configuration (for VCP models) ---
# Amortized inference uses a neural network to predict variational parameters
# from total UMI count instead of learning per-cell parameters.
# Only applies to nbvcp and zinbvcp models.
amortization:
  capture:
    enabled: false       # Enable amortized capture probability inference
    hidden_dims: [64, 32]  # MLP hidden layer dimensions
    activation: leaky_relu     # Activation: relu, gelu, silu, tanh, etc.
    output_transform: softplus  # Transform for constrained outputs: softplus or exp
    output_clamp_min: 0.1       # Min clamp for alpha/beta (null to disable)
    output_clamp_max: 50.0      # Max clamp for alpha/beta (null to disable)

# --- Annotation Prior (for mixture models) ---
# Provide per-cell prior beliefs about component assignments from adata.obs.
# annotation_key: column name (str) or list of column names in adata.obs.
#   When a list, composite labels are formed by joining values with "__".
#   e.g. ["cell_type", "treatment"] → "T__ctrl", "B__stim", ...
# annotation_confidence: kappa, prior strength (0=ignore, 3=default ~20x boost)
# annotation_component_order: explicit label-to-component index ordering (optional)
annotation_key: null
annotation_confidence: 3.0
annotation_component_order: null
# Minimum number of cells for an annotation label to be used as a component
# prior. Labels with fewer cells are treated as unlabeled (zero bias).
annotation_min_cells: null

# --- SVI-to-MCMC Initialization ---
# Path to a pickled ScribeSVIResults file to initialize MCMC chains.
# The SVI MAP estimates are extracted and used as starting values for NUTS.
# Only valid when inference=mcmc.  null = no initialization (default).
svi_init: null

# --- Resume Training / Initialization Source ---
# Optional path used to resume or warm-start an inference run.
# Supported values:
# - run directory (expects checkpoints/ and/or scribe_results.pkl)
# - checkpoints directory
# - scribe_results.pkl file
# Behavior:
# - inference=svi|vae: resumes from checkpoint state (requires checkpoints/)
# - inference=mcmc: if svi_init is null, uses scribe_results.pkl from this source
resume_from: null

# --- General Settings ---
seed: 42

# Data Processing
cells_axis: 0
# AnnData layer for raw counts (null → use .X).
# Can also be set per-dataset in the data config file (data.layer),
# which takes precedence over this global setting.
layer: null

# --- Output Configuration ---
# Optional custom output subdirectory (inside data directory)
# If set, overrides the auto-generated directory name from config overrides
output_dir: null

# --- Hydra settings ---
hydra:
  run:
    # Use output_dir if explicitly set by user, otherwise auto-generate from overrides
    # Note: We use 'model' in path to keep runs organized by model type
    # sanitize_dirname removes brackets [] which cause issues with Orbax checkpoint library
    dir: outputs/${data.name}/${model}/${inference.method}/${sanitize_dirname:${hydra:job.override_dirname}}
  sweep:
    # For --multirun (joblib) sweeps, use the same output structure as single runs
    # instead of Hydra's default multirun/ directory.  sweep.dir is resolved once
    # before jobs are composed, so per-job interpolations (data.name, model, etc.)
    # must go in sweep.subdir which is resolved per-job.
    dir: outputs
    subdir: ${data.name}/${model}/${inference.method}/${sanitize_dirname:${hydra:job.override_dirname}}
  job:
    name: ${data.name}_${inference.method}
    config:
      override_dirname:
        exclude_keys:
          - viz
          - viz.run_dir
          - viz.loss
          - viz.ecdf
          - viz.ppc
          - viz.umap
          - viz.heatmap
          - viz.mixture_ppc
          - viz.annotation_ppc
          - viz.format
          - viz.ecdf_opts
          - viz.ppc_opts
          - viz.umap_opts
          - viz.heatmap_opts
          - viz.mixture_ppc_opts
          - viz.annotation_ppc_opts
          - output_dir
          - resume_from
          - svi_init
          - inference.empirical_mixing
          # - inference.enable_x64
          - inference.early_stopping.enabled
          - inference.log_progress_lines
          - inference.batch_size
          - inference.n_steps
          - annotation_min_cells
          - data
