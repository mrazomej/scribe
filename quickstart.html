

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quickstart &mdash; SCRIBE  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Models" href="models/index.html" />
    <link rel="prev" title="Quick Overview" href="quickoverview.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            SCRIBE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickoverview.html">Quick Overview</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#simulating-data">Simulating Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fitting-the-model">Fitting the Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualizing-results">Visualizing Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#comparing-models">Comparing Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-the-results">Working with the Results</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Available Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="models/index.html">Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="results.html">Results Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples/index.html">Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SCRIBE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Quickstart</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/quickstart.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="quickstart">
<h1>Quickstart<a class="headerlink" href="#quickstart" title="Link to this heading"></a></h1>
<p>This tutorial will walk you through simulating data from a Negative
Binomial-Dirichlet Multinomial (NBDM) model, fitting it with SCRIBE, and
visualizing the results. See all the available models in the <a class="reference internal" href="models/models.html"><span class="doc">SCRIBE Models for Single-Cell RNA Sequencing</span></a>
documentation.</p>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Link to this heading"></a></h2>
<p>First, let’s import the necessary libraries and set up our directories:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scribe</span>

<span class="c1"># Define directories</span>
<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="s2">&quot;path/to/output&quot;</span>
<span class="n">FIG_DIR</span> <span class="o">=</span> <span class="s2">&quot;path/to/figures&quot;</span>

<span class="c1"># Create output directory</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">FIG_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="simulating-data">
<h2>Simulating Data<a class="headerlink" href="#simulating-data" title="Link to this heading"></a></h2>
<p>Next, we’ll simulate data from the NBDM model. We’ll generate data for 10,000
cells and 20,000 genes. For memory efficiency, we’ll use batching when
generating samples, generating the samples in the GPU using <a class="reference external" href="https://jax.readthedocs.io/en/latest/">JAX</a> and then moving the samples to the CPU
using <a class="reference external" href="https://numpy.org/">NumPy</a>.</p>
<p>First, let’s set up our simulation parameters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup random seed</span>
<span class="n">rng_key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Define dimensions</span>
<span class="n">n_cells</span> <span class="o">=</span> <span class="mi">10_000</span>
<span class="n">n_genes</span> <span class="o">=</span> <span class="mi">20_000</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4096</span>

<span class="c1"># Define prior parameters</span>
<span class="n">r_prior</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Shape and rate for Gamma prior on r</span>
<span class="n">p_prior</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Alpha and beta for Beta prior on p</span>
</pre></div>
</div>
<p>Now we’ll sample the true parameters from their respective prior distributions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split random keys</span>
<span class="n">key1</span><span class="p">,</span> <span class="n">key2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Sample true parameters</span>
<span class="n">r_true</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">key1</span><span class="p">,</span> <span class="n">r_prior</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_genes</span><span class="p">,))</span> <span class="o">/</span> <span class="n">r_prior</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">p_true</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">key2</span><span class="p">,</span> <span class="n">p_prior</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_prior</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>With our true parameters in hand, we can generate the count data. We’ll do this
in batches to manage memory usage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>

<span class="n">counts_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_genes</span><span class="p">))</span>

<span class="c1"># Sample in batches</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_cells</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="n">current_batch_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">n_cells</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">key_batch</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">fold_in</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="c1"># Sample from Negative Binomial distribution</span>
    <span class="n">batch_samples</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">NegativeBinomialProbs</span><span class="p">(</span>
        <span class="n">r_true</span><span class="p">,</span> <span class="n">p_true</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">key_batch</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">current_batch_size</span><span class="p">,))</span>

    <span class="n">counts_true</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">current_batch_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch_samples</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="fitting-the-model">
<h2>Fitting the Model<a class="headerlink" href="#fitting-the-model" title="Link to this heading"></a></h2>
<p>Now that we have our simulated data, we can fit it using SCRIBE. We’ll run the
inference for 25,000 steps using the base NBDM model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">n_steps</span> <span class="o">=</span> <span class="mi">25_000</span>

<span class="c1"># Run SCRIBE inference with the NBDM model (default settings)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">scribe</span><span class="o">.</span><span class="n">run_scribe</span><span class="p">(</span>
    <span class="n">counts</span><span class="o">=</span><span class="n">counts_true</span><span class="p">,</span>
    <span class="n">zero_inflated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>        <span class="c1"># NBDM model has no zero-inflation</span>
    <span class="n">variable_capture</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>     <span class="c1"># NBDM model has no variable capture probabilities</span>
    <span class="n">mixture_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>        <span class="c1"># Not using a mixture model</span>
    <span class="n">r_prior</span><span class="o">=</span><span class="n">r_prior</span><span class="p">,</span>            <span class="c1"># Using our defined priors</span>
    <span class="n">p_prior</span><span class="o">=</span><span class="n">p_prior</span><span class="p">,</span>
    <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="visualizing-results">
<h2>Visualizing Results<a class="headerlink" href="#visualizing-results" title="Link to this heading"></a></h2>
<p>Let’s create some visualizations to assess our model fit. First, let’s look at
the ELBO loss history:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot loss history</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">loss_history</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ELBO loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FIG_DIR</span><span class="p">,</span> <span class="s2">&quot;loss_history.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id1">
<a class="reference internal image-reference" href="_images/loss_history.png"><img alt="ELBO loss history" src="_images/loss_history.png" style="width: 350px;" />
</a>
<figcaption>
<p><span class="caption-text">ELBO loss history showing convergence of the model fitting process. The spiky
nature of the loss is due to the batching process.</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>We can also compare our inferred parameters to the true values. Let’s look at
the posterior distribution for p:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># Get posterior distribution for p</span>
<span class="n">distribution</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_distributions</span><span class="p">()[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span>

<span class="c1"># Plot posterior with true value</span>
<span class="n">scribe</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_posterior</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span>
    <span class="n">distribution</span><span class="p">,</span>
    <span class="n">ground_truth</span><span class="o">=</span><span class="n">p_true</span><span class="p">,</span>
    <span class="n">ground_truth_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">scribe</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">colors</span><span class="p">()[</span><span class="s2">&quot;dark_blue&quot;</span><span class="p">],</span>
    <span class="n">fill_color</span><span class="o">=</span><span class="n">scribe</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">colors</span><span class="p">()[</span><span class="s2">&quot;light_blue&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;posterior density&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FIG_DIR</span><span class="p">,</span> <span class="s2">&quot;p_posterior.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id2">
<a class="reference internal image-reference" href="_images/example_p_posterior.png"><img alt="Posterior distribution for p" src="_images/example_p_posterior.png" style="width: 350px;" />
</a>
<figcaption>
<p><span class="caption-text">Posterior distribution for the <span class="math notranslate nohighlight">\(p\)</span> parameter. The true value from
simulation is shown in black.</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Let’s generate a similar plot for various examples of the inferred <span class="math notranslate nohighlight">\(r\)</span>
parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select a few genes to visualize</span>
<span class="n">selected_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_genes</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Initialize figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="c1"># Flatten axes</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ parameter posterior distributions&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.005</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="c1"># Loop through selected genes</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
    <span class="c1"># Get the r distribution for this gene</span>
    <span class="n">gene_dist</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_distributions</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s2">&quot;scipy&quot;</span><span class="p">)[</span><span class="s1">&#39;r&#39;</span><span class="p">][</span><span class="n">selected_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="c1"># Plot distribution</span>
    <span class="n">scribe</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_posterior</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">,</span>
        <span class="n">gene_dist</span><span class="p">,</span>
        <span class="n">ground_truth</span><span class="o">=</span><span class="n">r_true</span><span class="p">[</span><span class="n">selected_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
        <span class="n">ground_truth_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">scribe</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">colors</span><span class="p">()[</span><span class="s2">&quot;dark_blue&quot;</span><span class="p">],</span>
        <span class="n">fill_color</span><span class="o">=</span><span class="n">scribe</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">colors</span><span class="p">()[</span><span class="s2">&quot;light_blue&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gene </span><span class="si">{</span><span class="n">selected_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FIG_DIR</span><span class="p">,</span> <span class="s2">&quot;r_posteriors.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id3">
<a class="reference internal image-reference" href="_images/example_r_posterior.png"><img alt="Posterior distribution for r" src="_images/example_r_posterior.png" style="width: 350px;" />
</a>
<figcaption>
<p><span class="caption-text">Posterior distribution for multiple examples of the <span class="math notranslate nohighlight">\(r\)</span> parameter. The
true value from simulation is shown in black.</span><a class="headerlink" href="#id3" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Finally, we can generate posterior predictive checks (PPCs) to assess model fit:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate PPC samples</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">ppc</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get_ppc_samples</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">43</span><span class="p">))</span>

<span class="c1"># Select a gene to visualize</span>
<span class="n">gene_idx</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Plot PPCs for the selected gene</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># Compute and plot credible regions</span>
<span class="n">credible_regions</span> <span class="o">=</span> <span class="n">scribe</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">compute_histogram_credible_regions</span><span class="p">(</span>
    <span class="n">ppc</span><span class="p">[</span><span class="s1">&#39;predictive_samples&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">gene_idx</span><span class="p">],</span>
    <span class="n">credible_regions</span><span class="o">=</span><span class="p">[</span><span class="mi">95</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">scribe</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">plot_histogram_credible_regions_stairs</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span>
    <span class="n">credible_regions</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">)</span>

<span class="c1"># Plot observed counts for this gene</span>
<span class="n">bin_edges</span> <span class="o">=</span> <span class="n">credible_regions</span><span class="p">[</span><span class="s1">&#39;bin_edges&#39;</span><span class="p">]</span>
<span class="n">hist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">counts_true</span><span class="p">[:,</span> <span class="n">gene_idx</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">hist</span> <span class="o">/</span> <span class="n">hist</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># Normalize</span>
<span class="n">ax</span><span class="o">.</span><span class="n">stairs</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Counts for Gene </span><span class="si">{</span><span class="n">gene_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FIG_DIR</span><span class="p">,</span> <span class="s2">&quot;ppc_example.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id4">
<a class="reference internal image-reference" href="_images/example_ppc.png"><img alt="Posterior predictive checks for a gene" src="_images/example_ppc.png" style="width: 350px;" />
</a>
<figcaption>
<p><span class="caption-text">Posterior predictive checks for the data generative process. The distribution
of counts observed in the simulated data is shown in black. The shades of
blue show the credible regions for the distribution of counts under the
posterior predictive distribution.</span><a class="headerlink" href="#id4" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The visual assessment of the model fit reveals that the model is able to capture
the data generating process. From here, we can continue our analysis with the
inferred parameters.</p>
</section>
<section id="comparing-models">
<h2>Comparing Models<a class="headerlink" href="#comparing-models" title="Link to this heading"></a></h2>
<p>Let’s compare the basic NBDM model with a Zero-Inflated Negative Binomial (ZINB)
model to see which fits the data better:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the ZINB model</span>
<span class="n">zinb_results</span> <span class="o">=</span> <span class="n">scribe</span><span class="o">.</span><span class="n">run_scribe</span><span class="p">(</span>
    <span class="n">counts</span><span class="o">=</span><span class="n">counts_true</span><span class="p">,</span>
    <span class="n">zero_inflated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>         <span class="c1"># Use zero-inflation</span>
    <span class="n">variable_capture</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">mixture_model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">r_prior</span><span class="o">=</span><span class="n">r_prior</span><span class="p">,</span>
    <span class="n">p_prior</span><span class="o">=</span><span class="n">p_prior</span><span class="p">,</span>
    <span class="n">gate_prior</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>          <span class="c1"># Prior for dropout probabilities</span>
    <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># Compare models using WAIC</span>
<span class="kn">from</span> <span class="nn">scribe.model_comparison</span> <span class="kn">import</span> <span class="n">compare_models</span>

<span class="c1"># Generate posterior samples if not already done</span>
<span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">posterior_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">results</span><span class="o">.</span><span class="n">get_posterior_samples</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="k">if</span> <span class="n">zinb_results</span><span class="o">.</span><span class="n">posterior_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">zinb_results</span><span class="o">.</span><span class="n">get_posterior_samples</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># Compare models</span>
<span class="n">comparison</span> <span class="o">=</span> <span class="n">compare_models</span><span class="p">(</span>
    <span class="p">[</span><span class="n">results</span><span class="p">,</span> <span class="n">zinb_results</span><span class="p">],</span>
    <span class="n">counts_true</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span>
<span class="p">)</span>

<span class="c1"># Display comparison results</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison</span><span class="p">[[</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;waic_2&quot;</span><span class="p">,</span> <span class="s2">&quot;delta_waic_2&quot;</span><span class="p">,</span> <span class="s2">&quot;weight_2&quot;</span><span class="p">]])</span>
</pre></div>
</div>
</section>
<section id="working-with-the-results">
<h2>Working with the Results<a class="headerlink" href="#working-with-the-results" title="Link to this heading"></a></h2>
<p>The results object provides several ways to access and work with the fitted
model:</p>
<ol class="arabic simple">
<li><p><strong>Accessing Parameters</strong>: Get direct access to model parameters</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Access p parameters (Beta distribution)</span>
<span class="n">p_concentration1</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;p_concentration1&#39;</span><span class="p">]</span>
<span class="n">p_concentration0</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;p_concentration0&#39;</span><span class="p">]</span>

<span class="c1"># Access r parameters (depends on distribution used - e.g., Gamma)</span>
<span class="n">r_concentration</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r_concentration&#39;</span><span class="p">]</span>
<span class="n">r_rate</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r_rate&#39;</span><span class="p">]</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p><strong>Working with Subsets of Genes</strong>: You can use indexing to focus on specific
genes</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get results for the first gene</span>
<span class="n">gene0_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Get results for genes 0, 10, and 20</span>
<span class="n">selected_genes</span> <span class="o">=</span> <span class="n">results</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]]</span>

<span class="c1"># Boolean indexing also works</span>
<span class="n">highly_variable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n_genes</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
<span class="n">hv_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">highly_variable</span><span class="p">]</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p><strong>Computing Log Likelihoods</strong>: Use the log likelihood function to evaluate model fit</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute log likelihoods for each cell</span>
<span class="n">log_liks</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">compute_log_likelihood</span><span class="p">(</span>
    <span class="n">counts_true</span><span class="p">,</span>
    <span class="n">return_by</span><span class="o">=</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span>
<span class="p">)</span>

<span class="c1"># Compute log likelihoods for each gene</span>
<span class="n">gene_log_liks</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">compute_log_likelihood</span><span class="p">(</span>
    <span class="n">counts_true</span><span class="p">,</span>
    <span class="n">return_by</span><span class="o">=</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Never trust any model fit (either from SCRIBE or any other analysis
pipeline) without at least visualizing how the fit compares to the observed
data. There are no silver bullets in statistics, and the best assessment of
any fitting procedure is to visualize how the fit compares to the observed
data.</p>
</div>
<p>This completes our quickstart guide! You’ve now learned how to:</p>
<ul class="simple">
<li><p>Simulate data from the NBDM model</p></li>
<li><p>Fit the model using SCRIBE</p></li>
<li><p>Compare different model types</p></li>
<li><p>Visualize and assess the results</p></li>
<li><p>Work with the ScribeResults object</p></li>
</ul>
<p>For more detailed examples and advanced usage, check out our tutorials section.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="quickoverview.html" class="btn btn-neutral float-left" title="Quick Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="models/index.html" class="btn btn-neutral float-right" title="Models" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Manuel Razo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>