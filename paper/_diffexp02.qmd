## Log-Ratio Coordinate Systems

The simplex $\Delta^{D-1}$ is a $(D-1)$-dimensional manifold embedded in
$\mathbb{R}^{D}$. To perform statistical inference on compositional data, we
require coordinate systems that map between the simplex and Euclidean space. In
@sec-normalization, we introduced the additive log-ratio (ALR) transformation,
which provides a bijective mapping between $\Delta^{D-1}$ and
$\mathbb{R}^{D-1}$ by taking log-ratios relative to a reference component.
While the ALR transformation enables proper probability density calculations, it
has a significant limitation: the choice of reference component is arbitrary,
and different choices lead to different statistical inferences.

In this section, we develop two alternative log-ratio coordinate systems that
address this limitation. The *centered log-ratio* (CLR) transformation provides
a symmetric, reference-free representation in $\mathbb{R}^{D}$, ideal for
gene-level inference. The *isometric log-ratio* (ILR) transformation provides
an orthonormal coordinate system in $\mathbb{R}^{D-1}$, ideal for gene-set and
pathway analysis.

### The Centered Log-Ratio (CLR) Transformation

#### Definition and basic properties

The centered log-ratio transformation, introduced by @aitchison1986, maps a
composition $\underline{\rho} \in \Delta^{D-1}$ to coordinates
$\underline{z}_{\text{CLR}} \in \mathbb{R}^{D}$ by taking logarithms and
centering relative to the geometric mean. Specifically, we define

$$
z_{\text{CLR},g} = \log(\rho_g) - \frac{1}{D} \sum_{j=1}^{D} \log(\rho_j), 
\quad g = 1, 2, \ldots, D.
$${#eq-diffexp-clr-definition}

Equivalently, we can write

$$
z_{\text{CLR},g} = \log\left(\frac{\rho_g}{\sqrt[D]{\prod_{j=1}^{D} \rho_j}}\right),
$${#eq-diffexp-clr-definition-ratio}

which makes explicit that each CLR coordinate is the log-ratio of a component
to the geometric mean of all components.

The CLR transformation has several important properties:

**Property 1: Sum-to-zero constraint.** Summing both sides of
@eq-diffexp-clr-definition over all $g$ gives

$$
\sum_{g=1}^{D} z_{\text{CLR},g} = \sum_{g=1}^{D} \log(\rho_g) - 
\frac{1}{D} \sum_{g=1}^{D} \sum_{j=1}^{D} \log(\rho_j).
$${#eq-diffexp-clr-sum-step1}

The double sum can be rewritten as

$$
\frac{1}{D} \sum_{g=1}^{D} \sum_{j=1}^{D} \log(\rho_j) = 
\frac{1}{D} \cdot D \cdot \sum_{j=1}^{D} \log(\rho_j) = 
\sum_{j=1}^{D} \log(\rho_j).
$${#eq-diffexp-clr-sum-step2}

Therefore,

$$
\sum_{g=1}^{D} z_{\text{CLR},g} = \sum_{g=1}^{D} \log(\rho_g) - 
\sum_{g=1}^{D} \log(\rho_g) = 0.
$${#eq-diffexp-clr-sum-zero}

This shows that CLR coordinates live in a $(D-1)$-dimensional subspace of
$\mathbb{R}^{D}$, specifically the subspace orthogonal to the vector
$\underline{1} = (1, 1, \ldots, 1)^{\top}$.

**Property 2: Reference-free representation.** Unlike the ALR transformation,
the CLR transformation treats all components symmetrically. There is no
distinguished reference component, and the transformation is invariant to
permutations of the component labels.

**Property 3: Interpretability.** Each CLR coordinate $z_{\text{CLR},g}$ has a
clear interpretation: it quantifies the log-ratio of gene $g$'s expression
relative to the average expression across all genes. Positive values indicate
expression above the geometric mean; negative values indicate expression below
the geometric mean.

#### Matrix form of the CLR transformation

The CLR transformation can be expressed in matrix form. Define the *centering
matrix* $\underline{\underline{C}} \in \mathbb{R}^{D \times D}$ as

$$
\underline{\underline{C}} = \underline{\underline{I}}_D - 
\frac{1}{D} \underline{1}\underline{1}^{\top},
$${#eq-diffexp-centering-matrix}

where $\underline{\underline{I}}_D$ is the $D \times D$ identity matrix and
$\underline{1}$ is the $D$-dimensional vector of ones. The entries of
$\underline{\underline{C}}$ are

$$
C_{ij} = \begin{cases}
1 - \frac{1}{D} & \text{if } i = j, \\
-\frac{1}{D} & \text{if } i \neq j.
\end{cases}
$${#eq-diffexp-centering-matrix-entries}

Then the CLR transformation can be written as

$$
\underline{z}_{\text{CLR}} = \underline{\underline{C}} \log(\underline{\rho}),
$${#eq-diffexp-clr-matrix-form}

where $\log(\underline{\rho})$ denotes element-wise logarithm.

The centering matrix has several useful properties. First, it is symmetric:
$\underline{\underline{C}}^{\top} = \underline{\underline{C}}$. Second, it is
idempotent:

$$
\underline{\underline{C}}^2 = \left(\underline{\underline{I}}_D - 
\frac{1}{D} \underline{1}\underline{1}^{\top}\right)^2.
$${#eq-diffexp-centering-idempotent-step1}

Expanding the square gives

$$
\underline{\underline{C}}^2 = \underline{\underline{I}}_D - 
\frac{2}{D} \underline{1}\underline{1}^{\top} + 
\frac{1}{D^2} \underline{1}\underline{1}^{\top}\underline{1}\underline{1}^{\top}.
$${#eq-diffexp-centering-idempotent-step2}

Since $\underline{1}^{\top}\underline{1} = D$, we have

$$
\underline{1}\underline{1}^{\top}\underline{1}\underline{1}^{\top} = 
\underline{1}(\underline{1}^{\top}\underline{1})\underline{1}^{\top} = 
D \underline{1}\underline{1}^{\top}.
$${#eq-diffexp-centering-idempotent-step3}

Substituting this result gives

$$
\underline{\underline{C}}^2 = \underline{\underline{I}}_D - 
\frac{2}{D} \underline{1}\underline{1}^{\top} + 
\frac{1}{D^2} \cdot D \underline{1}\underline{1}^{\top} = 
\underline{\underline{I}}_D - \frac{1}{D} \underline{1}\underline{1}^{\top} = 
\underline{\underline{C}}.
$${#eq-diffexp-centering-idempotent}

This idempotency property means that applying the centering transformation
twice is equivalent to applying it once, which is geometrically intuitive:
centering an already-centered vector leaves it unchanged.

Third, the centering matrix is a projection onto the subspace orthogonal to
$\underline{1}$:

$$
\underline{\underline{C}} \underline{1} = \underline{1} - 
\frac{1}{D} \underline{1}\underline{1}^{\top}\underline{1} = 
\underline{1} - \frac{1}{D} \cdot D \cdot \underline{1} = 
\underline{0}.
$${#eq-diffexp-centering-orthogonal}

This confirms that the range of $\underline{\underline{C}}$ is the $(D-1)$-
dimensional subspace $\{\underline{v} \in \mathbb{R}^{D} : \sum_i v_i = 0\}$.

#### Relationship between ALR and CLR transformations

The ALR and CLR transformations are closely related. Recall from
@sec-normalization that the ALR transformation uses the last component as a
reference and produces coordinates $\underline{z}_{\text{ALR}} \in
\mathbb{R}^{D-1}$ defined by

$$
z_{\text{ALR},i} = \log(\rho_i) - \log(\rho_D), \quad i = 1, 2, \ldots, D-1.
$${#eq-diffexp-alr-recall}

To relate the ALR and CLR transformations, we first embed the ALR coordinates
into $\mathbb{R}^{D}$ by appending a zero component corresponding to the
reference gene:

$$
\underline{z}_{\text{full}} = \begin{bmatrix}
\underline{z}_{\text{ALR}} \\
0
\end{bmatrix} = \begin{bmatrix}
\log(\rho_1) - \log(\rho_D) \\
\log(\rho_2) - \log(\rho_D) \\
\vdots \\
\log(\rho_{D-1}) - \log(\rho_D) \\
0
\end{bmatrix}.
$${#eq-diffexp-alr-embedded}

We claim that applying the centering matrix to this embedded vector yields the
CLR coordinates:

$$
\underline{z}_{\text{CLR}} = \underline{\underline{C}} \underline{z}_{\text{full}}.
$${#eq-diffexp-alr-to-clr-claim}

To verify this claim, we compute the $g$-th component of
$\underline{\underline{C}} \underline{z}_{\text{full}}$. For $g < D$:

$$
\left(\underline{\underline{C}} \underline{z}_{\text{full}}\right)_g = 
\left(1 - \frac{1}{D}\right) z_{\text{full},g} - 
\frac{1}{D} \sum_{j \neq g} z_{\text{full},j}.
$${#eq-diffexp-alr-to-clr-component-g}

Substituting $z_{\text{full},j} = \log(\rho_j) - \log(\rho_D)$ for $j < D$ and
$z_{\text{full},D} = 0$:

$$
\left(\underline{\underline{C}} \underline{z}_{\text{full}}\right)_g = 
\left(1 - \frac{1}{D}\right) [\log(\rho_g) - \log(\rho_D)] - 
\frac{1}{D} \sum_{j=1}^{D-1} [\log(\rho_j) - \log(\rho_D)].
$${#eq-diffexp-alr-to-clr-component-g-step1}

Expanding the sum:

$$
\left(\underline{\underline{C}} \underline{z}_{\text{full}}\right)_g = 
\log(\rho_g) - \log(\rho_D) - \frac{1}{D} \log(\rho_g) + 
\frac{1}{D} \log(\rho_D) - \frac{1}{D} \sum_{j=1}^{D-1} \log(\rho_j) + 
\frac{D-1}{D} \log(\rho_D).
$${#eq-diffexp-alr-to-clr-component-g-step2}

Collecting terms with $\log(\rho_g)$:

$$
\log(\rho_g) - \frac{1}{D} \log(\rho_g) = \frac{D-1}{D} \log(\rho_g).
$${#eq-diffexp-alr-to-clr-component-g-step3a}

Collecting terms with $\log(\rho_D)$:

$$
-\log(\rho_D) + \frac{1}{D} \log(\rho_D) + \frac{D-1}{D} \log(\rho_D) = 
\frac{-D + 1 + D - 1}{D} \log(\rho_D) = 0.
$${#eq-diffexp-alr-to-clr-component-g-step3b}

Therefore:

$$
\left(\underline{\underline{C}} \underline{z}_{\text{full}}\right)_g = 
\frac{D-1}{D} \log(\rho_g) - \frac{1}{D} \sum_{j=1}^{D-1} \log(\rho_j).
$${#eq-diffexp-alr-to-clr-component-g-step4}

We can rewrite this by adding and subtracting $\frac{1}{D} \log(\rho_D)$:

$$
\left(\underline{\underline{C}} \underline{z}_{\text{full}}\right)_g = 
\log(\rho_g) - \frac{1}{D} \log(\rho_g) - 
\frac{1}{D} \sum_{j=1}^{D-1} \log(\rho_j) = 
\log(\rho_g) - \frac{1}{D} \sum_{j=1}^{D} \log(\rho_j).
$${#eq-diffexp-alr-to-clr-component-g-final}

This is exactly the definition of $z_{\text{CLR},g}$ from
@eq-diffexp-clr-definition. A similar calculation shows that the $D$-th
component also satisfies the CLR definition. Thus, @eq-diffexp-alr-to-clr-claim
is verified.

This relationship is crucial for practical computations: given a Gaussian model
in ALR space, we can transform it to CLR space by embedding and applying the
centering matrix.

### The Isometric Log-Ratio (ILR) Transformation

#### Motivation and definition

While the CLR transformation provides an intuitive, reference-free
representation, it has a limitation for certain statistical purposes: the CLR
coordinates $\underline{z}_{\text{CLR}} \in \mathbb{R}^{D}$ are constrained to
lie in a $(D-1)$-dimensional subspace (the set of vectors summing to zero).
This redundancy can complicate some analyses, particularly those involving
orthogonal projections or gene-set testing.

The *isometric log-ratio* (ILR) transformation, introduced by
@egozcue2003, addresses this limitation by providing an orthonormal coordinate
system in $\mathbb{R}^{D-1}$ that spans the same subspace as the CLR
coordinates. Specifically, we seek a $(D-1) \times D$ matrix
$\underline{\underline{V}}$ such that:

1. **Orthonormality**: The rows of $\underline{\underline{V}}$ form an
orthonormal set, i.e., $\underline{\underline{V}}
\underline{\underline{V}}^{\top} = \underline{\underline{I}}_{D-1}$.

2. **CLR subspace**: Each row of $\underline{\underline{V}}$ sums to zero,
ensuring that $\underline{\underline{V}}$ maps into the CLR subspace.

Given such a matrix, the ILR transformation is defined as

$$
\underline{z}_{\text{ILR}} = \underline{\underline{V}} \underline{z}_{\text{CLR}}.
$${#eq-diffexp-ilr-definition}

The key advantage of this representation is that $\underline{z}_{\text{ILR}}
\in \mathbb{R}^{D-1}$ lives in an unconstrained space with orthogonal
coordinates, making it ideal for testing whether specific linear combinations of
genes (represented by the rows of $\underline{\underline{V}}$) exhibit
differential expression.

#### Construction of the Helmert basis

There are infinitely many choices of matrix $\underline{\underline{V}}$
satisfying the orthonormality and sum-to-zero constraints. We present the
*Helmert basis*, also known as the *sequential binary partition* basis, which
has a natural recursive construction and admits a closed-form expression.

The Helmert basis is constructed by sequentially partitioning genes into groups
and computing the balance between each new group and all previous groups. For
the $i$-th row of $\underline{\underline{V}}$ (where $i = 1, 2, \ldots, D-1$),
we create a vector that contrasts gene $i+1$ against the first $i$ genes.
Specifically, the $j$-th entry of the $i$-th row is

$$
V_{ij} = \begin{cases}
\sqrt{\frac{i}{i+1}} \cdot \frac{1}{i} & \text{if } j \leq i, \\
-\sqrt{\frac{i}{i+1}} & \text{if } j = i+1, \\
0 & \text{if } j > i+1.
\end{cases}
$${#eq-diffexp-helmert-formula}

Let us verify that this construction satisfies our requirements.

**Verification of sum-to-zero constraint.** For the $i$-th row, the sum of
entries is

$$
\sum_{j=1}^{D} V_{ij} = \sum_{j=1}^{i} \sqrt{\frac{i}{i+1}} \cdot \frac{1}{i} + 
\left(-\sqrt{\frac{i}{i+1}}\right) + \sum_{j=i+2}^{D} 0.
$${#eq-diffexp-helmert-sum-step1}

The first sum contains $i$ terms, each equal to $\sqrt{\frac{i}{i+1}} \cdot
\frac{1}{i}$, giving

$$
\sum_{j=1}^{i} \sqrt{\frac{i}{i+1}} \cdot \frac{1}{i} = 
i \cdot \sqrt{\frac{i}{i+1}} \cdot \frac{1}{i} = \sqrt{\frac{i}{i+1}}.
$${#eq-diffexp-helmert-sum-step2}

Therefore,

$$
\sum_{j=1}^{D} V_{ij} = \sqrt{\frac{i}{i+1}} - \sqrt{\frac{i}{i+1}} = 0.
$${#eq-diffexp-helmert-sum-zero}

**Verification of normalization.** The squared norm of the $i$-th row is

$$
\sum_{j=1}^{D} V_{ij}^2 = \sum_{j=1}^{i} \left(\sqrt{\frac{i}{i+1}} \cdot 
\frac{1}{i}\right)^2 + \left(-\sqrt{\frac{i}{i+1}}\right)^2.
$${#eq-diffexp-helmert-norm-step1}

Simplifying each term:

$$
\left(\sqrt{\frac{i}{i+1}} \cdot \frac{1}{i}\right)^2 = 
\frac{i}{i+1} \cdot \frac{1}{i^2} = \frac{1}{i(i+1)},
$${#eq-diffexp-helmert-norm-step2a}

$$
\left(-\sqrt{\frac{i}{i+1}}\right)^2 = \frac{i}{i+1}.
$${#eq-diffexp-helmert-norm-step2b}

The first sum contains $i$ terms:

$$
\sum_{j=1}^{i} \frac{1}{i(i+1)} = i \cdot \frac{1}{i(i+1)} = \frac{1}{i+1}.
$${#eq-diffexp-helmert-norm-step3}

Therefore,

$$
\sum_{j=1}^{D} V_{ij}^2 = \frac{1}{i+1} + \frac{i}{i+1} = 
\frac{1 + i}{i+1} = 1.
$${#eq-diffexp-helmert-norm-one}

This shows that each row has unit norm.

**Verification of orthogonality.** Consider two distinct rows $i$ and $k$ with
$i < k$. The inner product is

$$
\sum_{j=1}^{D} V_{ij} V_{kj} = \sum_{j=1}^{i} V_{ij} V_{kj} + 
V_{i,i+1} V_{k,i+1} + \sum_{j=i+2}^{k} V_{ij} V_{kj} + 
V_{ik+1} V_{k,k+1} + \sum_{j=k+2}^{D} V_{ij} V_{kj}.
$${#eq-diffexp-helmert-orthog-step1}

Since $i < k$, we have:
- For $j \leq i$: $V_{ij} = \sqrt{\frac{i}{i+1}} \cdot \frac{1}{i}$ and
$V_{kj} = \sqrt{\frac{k}{k+1}} \cdot \frac{1}{k}$.
- For $j = i+1$: $V_{i,i+1} = -\sqrt{\frac{i}{i+1}}$ and $V_{k,i+1} =
\sqrt{\frac{k}{k+1}} \cdot \frac{1}{k}$ (since $i+1 \leq k$).
- For $i+2 \leq j \leq k$: $V_{ij} = 0$.
- For $j = k+1$: $V_{i,k+1} = 0$ and $V_{k,k+1} = -\sqrt{\frac{k}{k+1}}$.
- For $j > k+1$: both $V_{ij} = 0$ and $V_{kj} = 0$.

Therefore, the inner product reduces to

$$
\sum_{j=1}^{D} V_{ij} V_{kj} = \sum_{j=1}^{i} \sqrt{\frac{i}{i+1}} \cdot 
\frac{1}{i} \cdot \sqrt{\frac{k}{k+1}} \cdot \frac{1}{k} + 
\left(-\sqrt{\frac{i}{i+1}}\right) \sqrt{\frac{k}{k+1}} \cdot \frac{1}{k}.
$${#eq-diffexp-helmert-orthog-step2}

The first sum has $i$ terms:

$$
\sum_{j=1}^{i} \sqrt{\frac{i}{i+1}} \cdot \frac{1}{i} \cdot 
\sqrt{\frac{k}{k+1}} \cdot \frac{1}{k} = 
i \cdot \frac{1}{i} \cdot \sqrt{\frac{i}{i+1}} \cdot \sqrt{\frac{k}{k+1}} 
\cdot \frac{1}{k} = \sqrt{\frac{i}{i+1}} \cdot \sqrt{\frac{k}{k+1}} \cdot 
\frac{1}{k}.
$${#eq-diffexp-helmert-orthog-step3}

Therefore,

$$
\sum_{j=1}^{D} V_{ij} V_{kj} = \sqrt{\frac{i}{i+1}} \cdot 
\sqrt{\frac{k}{k+1}} \cdot \frac{1}{k} - \sqrt{\frac{i}{i+1}} \cdot 
\sqrt{\frac{k}{k+1}} \cdot \frac{1}{k} = 0.
$${#eq-diffexp-helmert-orthog-zero}

This confirms that distinct rows are orthogonal.

Combining @eq-diffexp-helmert-sum-zero, @eq-diffexp-helmert-norm-one, and
@eq-diffexp-helmert-orthog-zero, we have verified that the Helmert basis
satisfies all required properties:

$$
\underline{\underline{V}} \underline{\underline{V}}^{\top} = 
\underline{\underline{I}}_{D-1}, \quad 
\underline{\underline{V}} \underline{1} = \underline{0}.
$${#eq-diffexp-helmert-properties}

#### Explicit examples

To build intuition, we present the Helmert basis explicitly for small values of
$D$.

**Example: $D = 3$ genes.** The Helmert basis is a $2 \times 3$ matrix:

$$
\underline{\underline{V}} = \begin{bmatrix}
\sqrt{\frac{1}{2}} & -\sqrt{\frac{1}{2}} & 0 \\
\sqrt{\frac{1}{6}} & \sqrt{\frac{1}{6}} & -\sqrt{\frac{2}{3}}
\end{bmatrix}.
$${#eq-diffexp-helmert-d3}

The first row contrasts gene 2 vs gene 1. The second row contrasts gene 3 vs
the average of genes 1 and 2. We verify orthonormality:

$$
\underline{\underline{V}} \underline{\underline{V}}^{\top} = \begin{bmatrix}
\frac{1}{2} + \frac{1}{2} + 0 & 
\frac{1}{\sqrt{12}} - \frac{1}{\sqrt{12}} + 0 \\
\frac{1}{\sqrt{12}} - \frac{1}{\sqrt{12}} + 0 & 
\frac{1}{6} + \frac{1}{6} + \frac{2}{3}
\end{bmatrix} = \begin{bmatrix}
1 & 0 \\
0 & 1
\end{bmatrix}.
$${#eq-diffexp-helmert-d3-verify}

**Example: $D = 4$ genes.** The Helmert basis is a $3 \times 4$ matrix:

$$
\underline{\underline{V}} = \begin{bmatrix}
\sqrt{\frac{1}{2}} & -\sqrt{\frac{1}{2}} & 0 & 0 \\
\sqrt{\frac{1}{6}} & \sqrt{\frac{1}{6}} & -\sqrt{\frac{2}{3}} & 0 \\
\sqrt{\frac{1}{12}} & \sqrt{\frac{1}{12}} & \sqrt{\frac{1}{12}} & 
-\sqrt{\frac{3}{4}}
\end{bmatrix}.
$${#eq-diffexp-helmert-d4}

Each row represents a balance: gene 2 vs gene 1; gene 3 vs genes {1,2}; gene 4
vs genes {1,2,3}.

#### Interpretation as balances

The ILR coordinates have a natural interpretation in terms of *compositional
balances* [@egozcue2003]. The $i$-th coordinate $z_{\text{ILR},i}$ measures the
log-ratio between two groups of genes: the first $i$ genes (weighted by their
geometric mean) versus gene $i+1$. Positive values indicate that gene $i+1$ has
higher relative expression than the geometric mean of the first $i$ genes;
negative values indicate the opposite.

This balance interpretation is particularly useful for gene-set and pathway
analysis, where we often wish to test whether a specific group of genes shows
coordinated differential expression. By choosing an appropriate ILR basis (or
equivalently, by constructing custom contrasts), we can directly test balances
that correspond to biological hypotheses.

